<!DOCTYPE html><html lang="zh-Hans"><head><!--[if IE]><style>body{display:none;}</style><script>alert('IE浏览器下无法展示效果，请更换浏览器！');var headNode=document.getElementsByTagName('head')[0];var refresh=document.createElement('meta');refresh.setAttribute('http-equiv','Refresh');refresh.setAttribute('Content','0; url=http://outdatedbrowser.com/');headNode.appendChild(refresh);</script><![endif]--><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge, chrome=1"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"><meta name="format-detection" content="telephone=no"><meta name="author" content="m01ly"><meta name="baidu-site-verification" content="yvSXOjM1ag"><meta name="google-site-verification" content="riwnp5QCq6dRKbhBa3d3aDZrfGLQVhMFN9d4fMGYuoU"><meta name="description" content="description123456"><meta property="og:type" content="website"><meta property="og:title" content="Hexo"><meta property="og:url" content="https://m01ly.github.io/page/2/index.html"><meta property="og:site_name" content="Hexo"><meta property="og:description" content="description123456"><meta property="og:locale"><meta property="article:author" content="m01ly"><meta property="article:tag" content="description123456"><meta name="twitter:card" content="summary"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="shortcut icon" href="/favicon.ico"><link href="//cdn.bootcss.com/fancybox/3.3.5/jquery.fancybox.min.css" rel="stylesheet"><link rel="stylesheet" href="/css/style.css"><title>Hexo</title><script src="//cdn.bootcss.com/jquery/3.3.1/jquery.min.js"></script><link href="//cdn.bootcss.com/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet"><script src="//cdn.bootcss.com/aos/2.2.0/aos.js"></script><script>var yiliaConfig={fancybox:!0,isHome:!0,isPost:!1,isArchive:!1,isTag:!1,isCategory:!1,fancybox_js:"//cdn.bootcss.com/fancybox/3.3.5/jquery.fancybox.min.js",search:!0}</script><script>yiliaConfig.jquery_ui=[!1]</script><script>yiliaConfig.rootUrl="/"</script><meta name="generator" content="Hexo 5.1.1"><link rel="alternate" href="/atom.xml" title="Hexo" type="application/rss+xml">
<link rel="stylesheet" href="/css/prism-a11y-dark.css" type="text/css">
<link rel="stylesheet" href="/css/prism-line-numbers.css" type="text/css"></head><body><div id="container"><div class="left-col"><div class="intrude-less"><header id="header" class="inner"><a href="/" class="profilepic"><img src="/img/avatar.jpg"></a><hgroup><h1 class="header-author"><a href="/">m01ly</a></h1></hgroup><p class="header-subtitle">人生在世，全靠命</p><form id="search-form"><input type="text" id="local-search-input" name="q" placeholder="search..." class="search form-control" autocomplete="off" autocorrect="off" searchonload="false"> <i class="fa fa-times" onclick="resetSearch()"></i></form><div id="local-search-result"></div><p class="no-result">No results found <i class="fa fa-spinner fa-pulse"></i></p><div id="switch-btn" class="switch-btn"><div class="icon"><div class="icon-ctn"><div class="icon-wrap icon-house" data-idx="0"><div class="birdhouse"></div><div class="birdhouse_holes"></div></div><div class="icon-wrap icon-ribbon hide" data-idx="1"><div class="ribbon"></div></div><div class="icon-wrap icon-link hide" data-idx="2"><div class="loopback_l"></div><div class="loopback_r"></div></div><div class="icon-wrap icon-me hide" data-idx="3"><div class="user"></div><div class="shoulder"></div></div></div></div><div class="tips-box hide"><div class="tips-arrow"></div><ul class="tips-inner"><li>菜单</li><li>标签</li><li>友情链接</li><li>目标</li></ul></div></div><div id="switch-area" class="switch-area"><div class="switch-wrap"><section class="switch-part switch-part1"><nav class="header-menu"><ul><li><a href="/">主页</a></li><li><a href="/archives/">所有文章</a></li><li><a href="/tags/">标签云</a></li><li><a href="/about/">简历</a></li></ul></nav><nav class="header-nav"><ul class="social"><a class="fa GitHub" target="_blank" rel="noopener" href="https://github.com/m01ly" title="GitHub"></a> <a class="fa RSS" href="/atom.xml" title="RSS"></a> <a class="fa 网易云音乐" target="_blank" rel="noopener" href="https://music.163.com/" title="网易云音乐"></a></ul><ul class="social"><div class="donateIcon-position"><p style="display:block"><a class="donateIcon" href="javascript:void(0)" onmouseout='var qr=document.getElementById("donate");qr.style.display="none"' onmouseenter='var qr=document.getElementById("donate");qr.style.display="block"'>赏</a></p><div id="donate"><img id="multipay" src="/img/multipay.png" width="250px" alt="m01ly Multipay"><div class="triangle"></div></div></div></ul></nav></section><section class="switch-part switch-part2"><div class="widget tagcloud" id="js-tagcloud"><ul class="tag-list" itemprop="keywords"><li class="tag-list-item"><a class="tag-list-link" href="/tags/TLS/" rel="tag">TLS</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E4%B8%AA%E4%BA%BA%E7%AC%94%E8%AE%B0/" rel="tag">个人笔记</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%AE%89%E8%A3%85%E6%95%99%E7%A8%8B/" rel="tag">安装教程</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%AF%86%E7%A0%81%E5%AD%A6/" rel="tag">密码学</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95/" rel="tag">渗透测试</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%BC%8F%E6%B4%9E%E6%89%AB%E6%8F%8F/" rel="tag">漏洞扫描</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E7%A7%BB%E5%8A%A8%E5%AE%89%E5%85%A8/" rel="tag">移动安全</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E9%9D%B6%E5%9C%BAwriteup/" rel="tag">靶场writeup</a></li></ul></div></section><section class="switch-part switch-part3"><div id="js-friends"><a class="main-nav-link switch-friends-link" target="_blank" rel="noopener" href="https://github.com/TechCatsLab">TechCatsLab</a> <a class="main-nav-link switch-friends-link" target="_blank" rel="noopener" href="https://yangchenglong11.github.io">YangChengLong</a> <a class="main-nav-link switch-friends-link" target="_blank" rel="noopener" href="https://jsharkc.github.io">LiuJiaChang</a> <a class="main-nav-link switch-friends-link" target="_blank" rel="noopener" href="http://blog.yusank.space">YusanKurban</a> <a class="main-nav-link switch-friends-link" target="_blank" rel="noopener" href="https://blog.lizebang.top">Lizebang</a> <a class="main-nav-link switch-friends-link" target="_blank" rel="noopener" href="https://github.com/sunanxiang">SunAnXiang</a> <a class="main-nav-link switch-friends-link" target="_blank" rel="noopener" href="https://github.com/DoubleWoodH">LinHao</a> <a class="main-nav-link switch-friends-link" target="_blank" rel="noopener" href="https://blog.littlechao.top">ShiChao</a> <a class="main-nav-link switch-friends-link" target="_blank" rel="noopener" href="https://github.com/Txiaozhe">TangXiaoJi</a> <a class="main-nav-link switch-friends-link" target="_blank" rel="noopener" href="https://github.com/LLLeon">JiaChenHui</a></div></section><section class="switch-part switch-part4"><div id="js-aboutme">不悲不喜，不卑不亢，努力成为一个更好的程序猿！</div></section></div></div></header></div></div><div class="hide-left-col" title="隐藏侧栏"><i class="fa fa-angle-double-left"></i></div><div class="mid-col"><nav id="mobile-nav"><div class="overlay"><div class="slider-trigger"></div><h1 class="header-author js-mobile-header hide"><a href="/" title="回到主页">m01ly</a></h1></div><div class="intrude-less"><header id="header" class="inner"><a href="/" class="profilepic"><img src="/img/avatar.jpg"></a><hgroup><h1 class="header-author"><a href="/" title="回到主页">m01ly</a></h1></hgroup><p class="header-subtitle">人生在世，全靠命</p><nav class="header-menu"><ul><li><a href="/">主页</a></li><li><a href="/archives/">所有文章</a></li><li><a href="/tags/">标签云</a></li><li><a href="/about/">简历</a></li><div class="clearfix"></div></ul></nav><nav class="header-nav"><ul class="social"><a class="fa GitHub" target="_blank" href="https://github.com/m01ly" title="GitHub"></a> <a class="fa RSS" target="_blank" href="/atom.xml" title="RSS"></a> <a class="fa 网易云音乐" target="_blank" href="https://music.163.com/" title="网易云音乐"></a></ul></nav></header></div><link class="menu-list" tags="标签" friends="友情链接" about="目标"></nav><div class="body-wrap"><article id="post-install-guide-centosInvm" class="article article-type-post" itemscope itemprop="blogPost"><div class="article-meta"><a href="/2020/09/11/install-guide-centosInvm/" class="article-date"><time class="published" datetime="2020-09-11T09:59:18.000Z" itemprop="datePublished">2020-09-11 发布</time> <time class="updated" datetime="2021-02-18T06:43:06.147Z" itemprop="dateUpdated">2021-02-18 更新</time></a></div><div class="article-inner"><input type="hidden" class="isFancy"><header class="article-header"><h1 itemprop="name"><a class="article-title" href="/2020/09/11/install-guide-centosInvm/">vm 安装centos 7教程详解</a></h1></header><div class="article-entry" itemprop="articleBody"><h1 id="1-前期准备"><a href="#1-前期准备" class="headerlink" title="1 前期准备"></a>1 前期准备</h1><p>1）VMware虚拟机</p><ol start="2"><li>centos镜像，我用的是centos7</li></ol><p>官网下载地址：</p><p><a target="_blank" rel="noopener" href="http://isoredirect.centos.org/centos/">http://isoredirect.centos.org/centos/</a> 或者 <a target="_blank" rel="noopener" href="http://apache.apooloo.cn/#/down/b6cfbd0dfda13a7f46125288e8ea8831">http://apache.apooloo.cn/#/down/b6cfbd0dfda13a7f46125288e8ea8831</a></p><p><img src="/2020/09/11/install-guide-centosInvm/1603246800490.png" alt="1603246800490"></p><h1 id="2-新建虚拟机"><a href="#2-新建虚拟机" class="headerlink" title="2 新建虚拟机"></a>2 新建虚拟机</h1><p>（1）新建虚拟机</p><p><img src="/2020/09/11/install-guide-centosInvm/1603246938246.png" alt="1603246938246"></p><p>（2）选择自定义虚拟机</p><p><img src="/2020/09/11/install-guide-centosInvm/1603246969975.png" alt="1603246969975"></p><p>（3）兼容性选择</p><p>选择当前虚拟机版本就可，尽量选择高版本，因为高版本虚拟机可以兼容低版本创建的虚拟机。</p><p><img src="/2020/09/11/install-guide-centosInvm/1603247049675.png" alt="1603247049675"></p><p>（4）</p><p><img src="/2020/09/11/install-guide-centosInvm/1603247121052.png" alt="1603247121052"></p><p>（5） 选择Linux的centos7,根据自己下载的镜像属性来选择</p><p><img src="/2020/09/11/install-guide-centosInvm/1603247200778.png" alt="1603247200778"></p><p>（6）填写虚拟机名称和虚拟机所在位置</p><p><img src="/2020/09/11/install-guide-centosInvm/1603247257115.png" alt="1603247257115"></p><p>（7）根据自己需求分配处理器和内核数量，因为有的软件安装需要双核的，因此我选了1个处理器，双核。</p><p><img src="/2020/09/11/install-guide-centosInvm/1603247301706.png" alt="1603247301706"></p><p>（8）我宿主机是8G的，给虚拟机分配了2G，1G内存会很卡，建议条件允许下分配2G。</p><p><img src="/2020/09/11/install-guide-centosInvm/1603247443067.png" alt="1603247443067"></p><p>（9）网络连接类型的选择，网络连接类型一共有桥接、NAT、仅主机和不联网四种。</p><p>桥接：选择桥接模式的话虚拟机和宿主机在网络上就是平级的关系，相当于连接在同一交换机上。</p><p>NAT：NAT模式就是虚拟机要联网得先通过宿主机才能和外面进行通信。</p><p>仅主机：虚拟机与宿主机直接连起来</p><p>桥接与NAT模式访问互联网过程，如下图所示</p><p><img src="https://img-blog.csdn.net/20180711224004659?watermark/2/text/aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2JhYnl4dWU=/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70" alt="img"></p><p>这里选择NAT模式：</p><p><img src="/2020/09/11/install-guide-centosInvm/1603249663181.png" alt="1603249663181"></p><p>（10）默认SCSI控制器即可，然后一直默认往下</p><p><img src="/2020/09/11/install-guide-centosInvm/1603247594330.png" alt="1603247594330"></p><p>（11）创建新的虚拟机</p><p><img src="/2020/09/11/install-guide-centosInvm/1603247633971.png" alt="1603247633971"></p><p>（12）分配磁盘，新手建议选择单个磁盘即可，满足需求又方便</p><p><img src="/2020/09/11/install-guide-centosInvm/1603247698163.png" alt="1603247698163"></p><p>（13）取消不需要的硬件，若不需要，可以移除声卡等硬件</p><p><img src="/2020/09/11/install-guide-centosInvm/1603247759405.png" alt="1603247759405"></p><p>（14）完成配置</p><p><img src="/2020/09/11/install-guide-centosInvm/1603247816395.png" alt="1603247816395"></p><h1 id="3-安装配置centos"><a href="#3-安装配置centos" class="headerlink" title="3 安装配置centos"></a>3 安装配置centos</h1><p>（1）导入centos镜像，选中创建的虚拟机，右击，选择设置</p><p><img src="/2020/09/11/install-guide-centosInvm/1603247903884.png" alt="1603247903884"></p><p>选择CD/DVD，然后使用ISO映像文件，导入官网下载的iso镜像，然后选择确定。</p><p><img src="/2020/09/11/install-guide-centosInvm/1603248005710.png" alt="1603248005710"></p><p>（2） 开启虚拟机</p><p><img src="/2020/09/11/install-guide-centosInvm/1603248058638.png" alt="1603248058638"></p><p>（3）开启虚拟机后会出现以下界面</p><ol><li>Install CentOS 7 安装CentOS 7</li><li>Test this media &amp; install CentOS 7 测试安装文件并安装CentOS 7</li><li>Troubleshooting 修复故障</li></ol><p>选择第一项，安装直接CentOS 7，回车，进入下面的界面</p><p><img src="/2020/09/11/install-guide-centosInvm/1603248982709.png" alt="1603248982709"></p><p>（4）选择语言， 英文、键盘选择美式键盘 ,点击continue</p><p><img src="/2020/09/11/install-guide-centosInvm/1603248188656.png" alt="1603248188656"></p><p>(5)进入设置面板，首先设置时间，点击进行DATE&amp;TIME</p><p><img src="/2020/09/11/install-guide-centosInvm/1603248238624.png" alt="1603248238624"></p><p>选择Asia区域，城市为上海，调节时间和日期如下，然后选择左上角的done</p><p><img src="/2020/09/11/install-guide-centosInvm/1603248344446.png" alt="1603248344446"></p><p>（6）返回设置面板后，选择需要安装的软件;</p><p><img src="/2020/09/11/install-guide-centosInvm/1603248414811.png" alt="1603248414811"></p><p>为了后面的虚拟机使用方便，选择了图像化界面，然后选择了几个组件，点击左上角done即可，如下：</p><p><img src="/2020/09/11/install-guide-centosInvm/1603248586590.png" alt="1603248586590"></p><p>（7）返回面板，进行磁盘划分</p><p><img src="/2020/09/11/install-guide-centosInvm/1603248642104.png" alt="1603248642104"></p><p>因为我们开始设置的是单个磁盘，这里直接选择默认的即可，点击done。</p><p><img src="/2020/09/11/install-guide-centosInvm/1603248690126.png" alt="1603248690126"></p><p>（8）返回设置面板，设置主机名和网卡信息</p><p><img src="/2020/09/11/install-guide-centosInvm/1603248829613.png" alt="1603248829613"></p><p>首先设置网卡，打开，看到IP地址（看不到IP地址的应该是选择了桥接模式，前面一定要选择NAT模式），然后输入主机名，点击Apply，设置完成后，点击左上角DOne。</p><p><img src="/2020/09/11/install-guide-centosInvm/1603250501053.png" alt="1603250501053"></p><p>（9）回到设置面板，点击右下角的begin installation，开始安装</p><p><img src="/2020/09/11/install-guide-centosInvm/1603248731326.png" alt="1603248731326"></p><p>（10）设置root密码：</p><p><img src="/2020/09/11/install-guide-centosInvm/1603249251084.png" alt="1603249251084"></p><p><img src="/2020/09/11/install-guide-centosInvm/1603249273725.png" alt="1603249273725"></p><p>（11）还可以设置管理员用户</p><p><img src="/2020/09/11/install-guide-centosInvm/1603249382172.png" alt="1603249382172"></p><p>输入相关用户名密码，点击左上角done即可。</p><p><img src="/2020/09/11/install-guide-centosInvm/1603249407944.png" alt="1603249407944"></p><p>等待系统安装完毕重启系统即可。</p><p><img src="/2020/09/11/install-guide-centosInvm/1603249729806.png" alt="1603249729806"></p><h1 id="4-常见网络配置"><a href="#4-常见网络配置" class="headerlink" title="4 常见网络配置"></a>4 常见网络配置</h1><p>REF：</p><p><a target="_blank" rel="noopener" href="https://blog.csdn.net/babyxue/article/details/80970526">超级详细的安装教程</a></p><link href="//src.wangriyu.wang/lib/Aplayer/APlayer.min.css" rel="stylesheet"><script src="//src.wangriyu.wang/lib/Aplayer/APlayer.min.js"></script><div id="aplayer"></div><script src="/js/player.js"></script></div><div class="article-info article-info-index"><div class="article-count"><div class="article-tag tagcloud"><ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E5%AE%89%E8%A3%85%E6%95%99%E7%A8%8B/" rel="tag">安装教程</a></li></ul></div><span class="post-count">总字数876</span> <span class="post-count">预计阅读3分钟</span></div><div class="clearfix"></div></div></div></article><article id="post-writeup-sqli-labs" class="article article-type-post" itemscope itemprop="blogPost"><div class="article-meta"><a href="/2020/09/11/writeup-sqli-labs/" class="article-date"><time class="published" datetime="2020-09-11T09:59:18.000Z" itemprop="datePublished">2020-09-11 发布</time> <time class="updated" datetime="2020-09-14T02:27:09.875Z" itemprop="dateUpdated">2020-09-14 更新</time></a></div><div class="article-inner"><input type="hidden" class="isFancy"><header class="article-header"><h1 itemprop="name"><a class="article-title" href="/2020/09/11/writeup-sqli-labs/">writeup-sqli-labs</a></h1></header><div class="article-entry" itemprop="articleBody"><h1 id="1-sqli-labs安装"><a href="#1-sqli-labs安装" class="headerlink" title="1 sqli-labs安装"></a>1 sqli-labs安装</h1><p>因为XAMPP（Apache+MySQL+PHP+PERL）是一个功能强大的建站集成软件包。这个软件包原来的名字是 LAMPP，但是为了避免误解，最新的几个版本就改名为 XAMPP 了。它可以在Windows、<a target="_blank" rel="noopener" href="https://baike.baidu.com/item/Linux">Linux</a>、Solaris、Mac OS X 等多种操作系统下安装使用。</p><p>因此我是打算在windows平台安装 XAMPP即可运行sqli-labs，下载地址如下：</p><p><a target="_blank" rel="noopener" href="https://www.apachefriends.org/zh_cn/download.html">https://www.apachefriends.org/zh_cn/download.html</a></p><p>启动xampp,start Apache,无法启动的可能是相关端口占用，解决办法如下：</p><p><a target="_blank" rel="noopener" href="https://blog.csdn.net/caizhigui/article/details/50332995">https://blog.csdn.net/caizhigui/article/details/50332995</a></p><p>sqli-labs源码地址：</p><p><a target="_blank" rel="noopener" href="https://github.com/Audi-1/sqli-labs">https://github.com/Audi-1/sqli-labs</a></p><link href="//src.wangriyu.wang/lib/Aplayer/APlayer.min.css" rel="stylesheet"><script src="//src.wangriyu.wang/lib/Aplayer/APlayer.min.js"></script><div id="aplayer"></div><script src="/js/player.js"></script></div><div class="article-info article-info-index"><div class="article-count"><div class="article-tag tagcloud"><ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E9%9D%B6%E5%9C%BAwriteup/" rel="tag">靶场writeup</a></li></ul></div><span class="post-count">总字数158</span> <span class="post-count">预计阅读1分钟</span></div><div class="clearfix"></div></div></div></article><article id="post-install-guide-elk-suricata" class="article article-type-post" itemscope itemprop="blogPost"><div class="article-meta"><a href="/2020/09/11/install-guide-elk-suricata/" class="article-date"><time class="published" datetime="2020-09-11T09:59:18.000Z" itemprop="datePublished">2020-09-11 发布</time> <time class="updated" datetime="2021-02-18T06:42:40.841Z" itemprop="dateUpdated">2021-02-18 更新</time></a></div><div class="article-inner"><input type="hidden" class="isFancy"><header class="article-header"><h1 itemprop="name"><a class="article-title" href="/2020/09/11/install-guide-elk-suricata/">suricata+elk搭建入侵检测系统</a></h1></header><div class="article-entry" itemprop="articleBody"><h1 id="1-引言"><a href="#1-引言" class="headerlink" title="1 引言"></a>1 引言</h1><p>最近有一个工作任务，需要利用Suricata作为IDS来检测出口流量，同时利用ELK进行数据的展示。看了很多suricata+elk进行流量监测的文章，但是都不太符合要求。</p><h1 id="2-部署架构"><a href="#2-部署架构" class="headerlink" title="2 部署架构"></a>2 部署架构</h1><p>整个架构如下表所示，有台机器装suricata用于分析流量，并装elk负责数据展示，后面数据量太大可能涉及elk集群，这里先不做考虑，仅仅自己实验。</p><table><thead><tr><th>机器</th><th>部署内容</th><th>IP</th></tr></thead><tbody><tr><td>流量分析和数据展示机器，称之为ids主机</td><td>ELK数据展示+suricata分析流量</td><td>多个集群</td></tr><tr><td>流量收集集群</td><td>抓取集群流量</td><td>10.0.0.1</td></tr></tbody></table><p>这个架构我们提供两种流量分析模式。</p><p>一种为在线模式：正常做法都是利用镜像流量，将所有集群抓取到的流量镜像到suricata机器，suricata实时在线处理这些流量,再elk展示出来。</p><p>二离线模式：但是因为机器是部署在阿里云上的，因此做镜像流量较困难，当然采用Amazon VPC功能可以实现镜像流量，如<a target="_blank" rel="noopener" href="https://aws.amazon.com/cn/blogs/china/using-vpc-traffic-mirroring-to-construct-network-intrusion-detection-system-update/"> VPC Traffic Mirroring 构建网络入侵检测系统</a>文章，这里我们没有购买此产品，初步架构部署为离线模式。即流量收集集群将抓取的流量文件推送到suricata主机上，suricata -r分析流量文件包，产生log日志，然后elk将log数据展示出来。</p><p><img src="/2020/09/11/install-guide-elk-suricata/1611038936479.png" alt="1611038936479"></p><h1 id="3-环境部署"><a href="#3-环境部署" class="headerlink" title="3 环境部署"></a>3 环境部署</h1><h2 id="3-1-suricata部署"><a href="#3-1-suricata部署" class="headerlink" title="3.1 suricata部署"></a>3.1 suricata部署</h2><p>按照<a target="_blank" rel="noopener" href="https://redmine.openinfosecfoundation.org/projects/suricata/wiki/_Logstash_Kibana_and_Suricata_JSON_output">官网suricata+elk部署指南</a></p><h3 id="3-1-1-确认suricata安装了libjansson"><a href="#3-1-1-确认suricata安装了libjansson" class="headerlink" title="3.1.1 确认suricata安装了libjansson"></a>3.1.1 确认suricata安装了libjansson</h3><p>如下查看配置信息，确认 libjansson support:为yes即可</p><pre class="line-numbers language-bash"><code class="language-bash">$ suricata --build-info
This is Suricata version 2.0 RELEASE
Features: NFQ PCAP_SET_BUFF LIBPCAP_VERSION_MAJOR<span class="token operator">=</span>1 AF_PACKET HAVE_PACKET_FANOUT LIBCAP_NG LIBNET1.1 HAVE_HTP_URI_NORMALIZE_HOOK HAVE_NSS HAVE_LIBJANSSON 
<span class="token punctuation">..</span>.
  libnss support:                          <span class="token function">yes</span>
  libnspr support:                         <span class="token function">yes</span>
  libjansson support:                     --<span class="token operator">></span> <span class="token function">yes</span> <span class="token operator">&lt;</span>--
  Prelude support:                         no
  PCRE jit:                                no
  libluajit:                               no
  libgeoip:                                <span class="token function">yes</span>
  Non-bundled htp:                         <span class="token function">yes</span>
  Old barnyard2 support:                   no
  CUDA enabled:                            no
<span class="token punctuation">..</span>.<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="3-1-2-修改配置文件"><a href="#3-1-2-修改配置文件" class="headerlink" title="3.1.2  修改配置文件"></a>3.1.2 修改配置文件</h3><p>修改配置文件suricata.yaml如下</p><pre class="line-numbers language-yaml"><code class="language-yaml">  <span class="token comment" spellcheck="true"># "United" event log in JSON format</span>
  <span class="token punctuation">-</span> <span class="token key atrule">eve-log</span><span class="token punctuation">:</span>
      <span class="token key atrule">enabled</span><span class="token punctuation">:</span> yes
      <span class="token key atrule">type</span><span class="token punctuation">:</span> file <span class="token comment" spellcheck="true">#file|syslog|unix_dgram|unix_stream</span>
      <span class="token key atrule">filename</span><span class="token punctuation">:</span> eve.json
      <span class="token comment" spellcheck="true"># the following are valid when type: syslog above</span>
      <span class="token comment" spellcheck="true">#identity: "suricata" </span>
      <span class="token comment" spellcheck="true">#facility: local5</span>
      <span class="token comment" spellcheck="true">#level: Info ## possible levels: Emergency, Alert, Critical,</span>
                   <span class="token comment" spellcheck="true">## Error, Warning, Notice, Info, Debug</span>
      <span class="token key atrule">types</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> alert
        <span class="token punctuation">-</span> <span class="token key atrule">http</span><span class="token punctuation">:</span>
            <span class="token key atrule">extended</span><span class="token punctuation">:</span> yes     <span class="token comment" spellcheck="true"># enable this for extended logging information</span>
        <span class="token punctuation">-</span> dns
        <span class="token punctuation">-</span> <span class="token key atrule">tls</span><span class="token punctuation">:</span>
            <span class="token key atrule">extended</span><span class="token punctuation">:</span> yes     <span class="token comment" spellcheck="true"># enable this for extended logging information</span>
        <span class="token punctuation">-</span> <span class="token key atrule">files</span><span class="token punctuation">:</span>
            <span class="token key atrule">force-magic</span><span class="token punctuation">:</span> yes   <span class="token comment" spellcheck="true"># force logging magic on all logged files</span>
            <span class="token key atrule">force-md5</span><span class="token punctuation">:</span> yes     <span class="token comment" spellcheck="true"># force logging of md5 checksums</span>
        <span class="token comment" spellcheck="true">#- drop</span>
        <span class="token punctuation">-</span> ssh
        <span class="token punctuation">-</span> smtp
        <span class="token punctuation">-</span> flow<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="3-2-安装ES"><a href="#3-2-安装ES" class="headerlink" title="3.2 安装ES"></a>3.2 安装ES</h2><h3 id="3-2-1-需要java-1-8-环境"><a href="#3-2-1-需要java-1-8-环境" class="headerlink" title="3.2.1 需要java 1.8 环境"></a>3.2.1 需要java 1.8 环境</h3><p>ES安装需要java1.8环境，因此需要先检查主机是否有java1.8环境。</p><p><a target="_blank" rel="noopener" href="http://www.justdojava.com/2019/08/11/elk-install/">http://www.justdojava.com/2019/08/11/elk-install/</a></p><p><img src="/2020/09/11/install-guide-elk-suricata/1603867131448.png" alt="1603867131448"></p><p>（1）查看java版本：</p><pre class="line-numbers language-bash"><code class="language-bash"><span class="token function">which</span> java
<span class="token function">whereis</span> java
java -version<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p><img src="/2020/09/11/install-guide-elk-suricata/1603862442212.png" alt="1603862442212"></p><p>（2）卸载旧版本（这里注意centos7自带的是1.8的jre，需要卸载掉/或者yum -y install java-1.8.0-openjdk安装的也仅仅是jre）</p><pre class="line-numbers language-bash"><code class="language-bash"><span class="token punctuation">[</span>root@ids0001 ~<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># find / -name java</span>
/etc/pki/ca-trust/extracted/java
/etc/pki/java
/etc/alternatives/java
/etc/java
/var/lib/alternatives/java
/usr/bin/java
/usr/lib/java
/usr/lib/jvm/java-1.8.0-openjdk-1.8.0.262.b10-0.el7_8.x86_64/jre/bin/java
/usr/share/elasticsearch/jdk/bin/java
/usr/share/java
<span class="token function">sudo</span> <span class="token function">rm</span> -rf /etc/pki/ca-trust/extracted/java
<span class="token function">sudo</span> <span class="token function">rm</span> -rf /etc/pki/java
<span class="token function">sudo</span> <span class="token function">rm</span> -rf /etc/alternatives/java
<span class="token function">sudo</span> <span class="token function">rm</span> -rf /etc/java
<span class="token function">sudo</span> <span class="token function">rm</span> -rf /var/lib/alternatives/java
<span class="token function">sudo</span> <span class="token function">rm</span> -rf /usr/bin/java
<span class="token function">sudo</span> <span class="token function">rm</span> -rf /usr/lib/java
<span class="token function">sudo</span> <span class="token function">rm</span> -rf /usr/lib/jvm/java-1.8.0-openjdk-1.8.0.262.b10-0.el7_8.x86_64/jre/bin/java
<span class="token function">sudo</span> <span class="token function">rm</span> -rf /usr/share/elasticsearch/jdk/bin/java
<span class="token function">sudo</span> <span class="token function">rm</span> -rf /usr/share/java<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>（3）安装1.8版本java</p><p>执行下面命令进行安装1.8jdk。这里有个地方要注意，要选择 要带有-devel的安装，因为这个安装的是jdk，而那个不带-devel的安装完了其实是jre。</p><pre class="line-numbers language-bash"><code class="language-bash">yum <span class="token function">install</span> -y java-1.8.0-openjdk-devel.x86_64
java -version<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p><img src="/2020/09/11/install-guide-elk-suricata/1603870468396.png" alt="1603870468396"></p><p>（4）修改环境变量</p><pre class="line-numbers language-bash"><code class="language-bash"><span class="token function">vi</span> /etc/profile<span class="token comment" spellcheck="true">#修改JAVA_HOME为jdk目录</span>
<span class="token keyword">echo</span> <span class="token variable">$JAVA_HOME</span><span class="token comment" spellcheck="true">#查看环境变量</span>
/usr/lib/jvm/java-1.8.0-openjdk-1.8.0.282.b08-1.el7_9.x86_64<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p><img src="/2020/09/11/install-guide-elk-suricata/1603868088313.png" alt="1603868088313"></p><p>让profile文件立即生效 ，1.8java安装成功</p><pre class="line-numbers language-bash"><code class="language-bash"><span class="token punctuation">[</span>root@ids0001 ~<span class="token punctuation">]</span><span class="token comment" spellcheck="true">#  source /etc/profile</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p><img src="/2020/09/11/install-guide-elk-suricata/1603867783946.png" alt="1603867783946"></p><h3 id="3-2-2安装"><a href="#3-2-2安装" class="headerlink" title="3.2.2安装"></a>3.2.2安装</h3><p><a target="_blank" rel="noopener" href="https://www.elastic.co/cn/downloads/elasticsearch">官网下载</a></p><pre class="line-numbers language-bash"><code class="language-bash"><span class="token punctuation">[</span>root@m01ly ~<span class="token punctuation">]</span><span class="token comment" spellcheck="true">#sudo wget https://artifacts.elastic.co/downloads/elasticsearch/elasticsearch-7.8.0-x86_64.rpm</span>
<span class="token punctuation">[</span>root@m01ly ~<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># rpm -ivh elasticsearch-7.8.0-x86_64.rpm</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p><img src="/2020/09/11/install-guide-elk-suricata/1603803405841.png" alt="1603803405841"></p><p>安装目录： 一般是装在/usr/share/elasticsearch/下。</p><p>报错1：</p><p><img src="/2020/09/11/install-guide-elk-suricata/1603866798862.png" alt="1603866798862"></p><p>解决办法：删除其他版本的java</p><pre><code>[root@ids0001 ~]# find / -name java</code></pre><p><img src="/2020/09/11/install-guide-elk-suricata/1603866831066.png" alt="1603866831066"></p><p>版本太低 ，都删除，</p><pre><code>sudo rm -rf /opt/jdk1.7.0_79/
sudo rm -rf /opt/jdk1.8.0_60/</code></pre><h3 id="3-2-3设置data的目录"><a href="#3-2-3设置data的目录" class="headerlink" title="3.2.3设置data的目录"></a>3.2.3设置data的目录</h3><p>创建/data/es-data目录，用于elasticsearch数据的存放</p><pre><code>mkdir -p /data/es-data</code></pre><p>修改该目录的拥有者为elasticsearch</p><pre><code>chown -R elasticsearch:elasticsearch /data/es-data</code></pre><h3 id="3-2-4设置log的目录"><a href="#3-2-4设置log的目录" class="headerlink" title="3.2.4设置log的目录"></a>3.2.4设置log的目录</h3><p>创建/data/es-log目录，用于elasticsearch日志的存放</p><pre><code>mkdir -p /log/es-log</code></pre><p>修改该目录的拥有者为elasticsearch</p><pre class="line-numbers language-bash"><code class="language-bash"><span class="token function">chown</span> -R elasticsearch:elasticsearch /log/es-log<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h3 id="3-2-5-修改配置文件elasticsearch-yml"><a href="#3-2-5-修改配置文件elasticsearch-yml" class="headerlink" title="3.2.5 修改配置文件elasticsearch.yml"></a>3.2.5 修改配置文件elasticsearch.yml</h3><pre class="line-numbers language-bash"><code class="language-bash">vim /etc/elasticsearch/elasticsearch.yml
<span class="token function">egrep</span> -v <span class="token string">"^#|^$"</span> /etc/elasticsearch/elasticsearch.yml#查看配置<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><pre class="line-numbers language-bash"><code class="language-bash"><span class="token comment" spellcheck="true">#设置data存放的路径为/data/es-data</span>
path.data: /data/es-data

<span class="token comment" spellcheck="true">#设置logs日志的路径为/log/es-log</span>
path.logs: /log/es-log

<span class="token comment" spellcheck="true">#设置内存不使用交换分区</span>
bootstrap.memory_lock: <span class="token boolean">false</span>
<span class="token comment" spellcheck="true">#配置了bootstrap.memory_lock为true时反而会引发9200不会被监听，原因不明</span>

<span class="token comment" spellcheck="true">#设置允许所有ip可以连接该elasticsearch</span>
network.host: 0.0.0.0

<span class="token comment" spellcheck="true">#开启监听的端口为9200</span>
http.port: 9200

<span class="token comment" spellcheck="true">#增加新的参数，为了让elasticsearch-head插件可以访问es (5.x版本，如果没有可以自己手动加)</span>
http.cors.enabled: <span class="token boolean">true</span>
http.cors.allow-origin: <span class="token string">"*"</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="3-2-6启动elasticsearch"><a href="#3-2-6启动elasticsearch" class="headerlink" title="3.2.6启动elasticsearch"></a>3.2.6启动elasticsearch</h3><pre class="line-numbers language-bash"><code class="language-bash"><span class="token function">sudo</span> systemctl start elasticsearch<span class="token comment" spellcheck="true">#启动   </span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>出错1：</p><p><img src="/2020/09/11/install-guide-elk-suricata/1603863067395.png" alt="1603863067395"></p><p>solution:配置文件加下面代码：</p><pre><code>bootstrap.system_call_filter: false 
cluster.initial_master_nodes: [&quot;node-1&quot;] </code></pre><p>查看状态</p><pre class="line-numbers language-bash"><code class="language-bash">systemctl status elasticsearch <span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>设置开机启动</p><pre class="line-numbers language-bash"><code class="language-bash">systemctl <span class="token function">enable</span> elasticsearch <span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>启动成功之后，测试服务是否开启</p><pre class="line-numbers language-bash"><code class="language-bash">curl -X GET http://localhost:9200 <span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p><img src="/2020/09/11/install-guide-elk-suricata/1603805643890.png" alt="1603805643890"></p><h3 id="3-2-7-卸载"><a href="#3-2-7-卸载" class="headerlink" title="3.2.7 卸载"></a>3.2.7 卸载</h3><pre class="line-numbers language-bash"><code class="language-bash"><span class="token punctuation">[</span>root@ids0001 ~<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># yum remove elasticsearch</span>
<span class="token punctuation">[</span>root@ids0001 ~<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># sudo rm -rf /var/lib/elasticsearch/</span>
<span class="token function">sudo</span> <span class="token function">rm</span> -rf /etc/elasticsearch<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><h2 id="3-3-logStash"><a href="#3-3-logStash" class="headerlink" title="3.3  logStash"></a>3.3 logStash</h2><h3 id="3-3-1-下载安装"><a href="#3-3-1-下载安装" class="headerlink" title="3.3.1 下载安装"></a>3.3.1 下载安装</h3><pre class="line-numbers language-bash"><code class="language-bash"><span class="token punctuation">[</span>root@m01ly ~<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># sudo wget https://artifacts.elastic.co/downloads/logstash/logstash-7.8.0.rpm</span>
<span class="token punctuation">[</span>root@m01ly ~<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># rpm -ivh logstash-7.8.0.rpm</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p><img src="/2020/09/11/install-guide-elk-suricata/1603805962140.png" alt="1603805962140"></p><h3 id="3-2-2设置data的目录"><a href="#3-2-2设置data的目录" class="headerlink" title="3.2.2设置data的目录"></a>3.2.2设置data的目录</h3><p>创建/data/ls-data目录，用于logstash数据的存放</p><pre class="line-numbers language-bash"><code class="language-bash"><span class="token function">mkdir</span> -p /data/ls-data <span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>修改该目录的拥有者为logstash</p><pre class="line-numbers language-bash"><code class="language-bash"><span class="token function">chown</span> -R logstash:logstash /data/ls-data <span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h3 id="3-3-3设置log的目录"><a href="#3-3-3设置log的目录" class="headerlink" title="3.3.3设置log的目录"></a>3.3.3设置log的目录</h3><p>创建/data/ls-log目录，用于logstash日志的存放</p><pre class="line-numbers language-bash"><code class="language-bash"><span class="token function">mkdir</span> -p /log/ls-log <span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>修改该目录的拥有者为logstash</p><pre class="line-numbers language-bash"><code class="language-bash"><span class="token function">chown</span> -R logstash:logstash /log/ls-log <span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h3 id="3-3-4设置conf-d的目录，创建配置文件"><a href="#3-3-4设置conf-d的目录，创建配置文件" class="headerlink" title="3.3.4设置conf.d的目录，创建配置文件"></a>3.3.4设置conf.d的目录，创建配置文件</h3><pre class="line-numbers language-bash"><code class="language-bash"><span class="token comment" spellcheck="true">#进入logstash目录 cd /etc/logstash </span>
<span class="token comment" spellcheck="true">#创建conf.d的目录 mkdir conf.d </span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>创建配置文件，日志内容输出到elasticsearch中，如下所示</p><pre class="line-numbers language-bash"><code class="language-bash">vim /etc/logstash/conf.d/logstash.conf
<span class="token function">vi</span> /etc/logstash/conf.d/logstash.conf
<span class="token function">chown</span> root /etc/logstash/conf.d/logstash.conf <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>logstash.conf 文件内容如下：注意其中的path为suricata日志：/var/log/suricata/eve.json</p><pre><code>input &#123;
  file &#123;
    path =&gt; [&quot;/var/log/suricata/eve.json&quot;]
    codec =&gt; json
  &#125;
&#125;

filter &#123;

&#125;

output &#123;
  elasticsearch &#123;
    hosts =&gt; &quot;127.0.0.1:9200&quot;
    index =&gt; &quot;suricata-%&#123;+YYYY.MM.dd&#125;&quot;
  &#125;
&#125;</code></pre><h3 id="3-3-5修改配置文件logstash-yml"><a href="#3-3-5修改配置文件logstash-yml" class="headerlink" title="3.3.5修改配置文件logstash.yml"></a>3.3.5修改配置文件logstash.yml</h3><pre class="line-numbers language-bash"><code class="language-bash">vim /etc/logstash/logstash.yml<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>内容如下：</p><pre class="line-numbers language-bash"><code class="language-bash"><span class="token comment" spellcheck="true"># 设置数据的存储路径为/data/ls-data </span>
path.data: /data/ls-data 
<span class="token comment" spellcheck="true"># 设置管道配置文件路径为/etc/logstash/conf.d </span>
path.config: /etc/logstash/conf.d 
<span class="token comment" spellcheck="true"># 设置日志文件的存储路径为/log/ls-log </span>
path.logs: /log/ls-log <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="3-3-6启动logstash"><a href="#3-3-6启动logstash" class="headerlink" title="3.3.6启动logstash"></a>3.3.6启动logstash</h3><p>启动logstash命令如下，注意该命令不会指定配置文件启动。</p><pre class="line-numbers language-bash"><code class="language-bash">systemctl start logstash <span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p><img src="/2020/09/11/install-guide-elk-suricata/1603951213781.png" alt="1603951213781"></p><p>查看</p><pre class="line-numbers language-bash"><code class="language-bash">systemctl status logstash <span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>设置开机启动</p><pre class="line-numbers language-bash"><code class="language-bash">systemctl <span class="token function">enable</span> logstash <span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h3 id="3-3-7-测试logstash"><a href="#3-3-7-测试logstash" class="headerlink" title="3.3.7 测试logstash"></a>3.3.7 测试logstash</h3><p>–config.test_and_exit表示，检查测试创建的logstash.conf配置文件，是否有问题，如果没有问题，执行之后，<strong>显示Configuration OK 证明配置成功！</strong></p><pre class="line-numbers language-bash"><code class="language-bash">/usr/share/logstash/bin/logstash  -f /etc/logstash/conf.d/logstash.conf --config.test_and_exit <span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>**如果报错：WARNING: Could not find logstash.yml which is typically located in $LS_HOME/config or /etc/logstash. You can specify the path using –path.settings. **</p><p>解决办法：</p><pre class="line-numbers language-bash"><code class="language-bash"><span class="token function">cd</span> /usr/share/logstash 
<span class="token function">ln</span> -s /etc/logstash ./config <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>测试成功！</p><p><img src="/2020/09/11/install-guide-elk-suricata/1603806572175.png" alt="1603806572175"></p><h3 id="3-3-8-logstash指定配置进行运行"><a href="#3-3-8-logstash指定配置进行运行" class="headerlink" title="3.3.8 logstash指定配置进行运行"></a>3.3.8 logstash指定配置进行运行</h3><p>指定logstash.conf配置文件，以后台的方式运用，执行这段命令之后，需要回车一下</p><pre class="line-numbers language-bash"><code class="language-bash"><span class="token function">nohup</span> /usr/share/logstash/bin/logstash -f /etc/logstash/conf.d/logstash.conf <span class="token operator">&amp;</span> <span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>检查logstash是否启动</p><pre class="line-numbers language-bash"><code class="language-bash"><span class="token function">ps</span> -ef<span class="token operator">|</span><span class="token function">grep</span> logstash <span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>显示如下信息，说明启动了</p><p><img src="http://www.justdojava.com/assets/images/2019/java/image-jay/a29ab2058ff04df4bac898a8759f1a47.jpg" alt="img"></p><h3 id="3-3-9-卸载"><a href="#3-3-9-卸载" class="headerlink" title="3.3.9 卸载"></a>3.3.9 卸载</h3><pre class="line-numbers language-bash"><code class="language-bash"><span class="token function">sudo</span> <span class="token function">rm</span> -rf /etc/default/logstash \
/etc/logstash \
/var/lib/logstash \
/var/log/logstash \
/usr/share/logstash \
/usr/share/kibana/x-pack/plugins/logstash \
/usr/share/kibana/x-pack/plugins/monitoring/public/components/logstash \
/usr/share/kibana/x-pack/plugins/monitoring/public/components/metricbeat_migration/instruction_steps/logstash \
/usr/share/kibana/x-pack/plugins/monitoring/public/lib/logstash \
/usr/share/kibana/x-pack/plugins/monitoring/public/views/logstash \
/usr/share/kibana/x-pack/plugins/monitoring/server/lib/logstash \
/usr/share/kibana/x-pack/plugins/monitoring/server/lib/metrics/logstash \
/usr/share/kibana/x-pack/plugins/monitoring/server/routes/api/v1/logstash<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="3-3-10"><a href="#3-3-10" class="headerlink" title="3.3.10"></a>3.3.10</h3><p>找错，查看logstash运行日志</p><pre class="line-numbers language-bash"><code class="language-bash">systemctl status logstash -l<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h2 id="3-4-kibana"><a href="#3-4-kibana" class="headerlink" title="3.4  kibana"></a>3.4 kibana</h2><h3 id="3-4-1-安装"><a href="#3-4-1-安装" class="headerlink" title="3.4.1 安装"></a>3.4.1 安装</h3><p><a target="_blank" rel="noopener" href="https://www.elastic.co/cn/downloads/kibana">官网下载kibaba7.8版本</a></p><pre class="line-numbers language-bash"><code class="language-bash"><span class="token punctuation">[</span>root@m01ly ~<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># sudo wget https://artifacts.elastic.co/downloads/kibana/kibana-7.8.0-x86_64.rpm</span>
<span class="token punctuation">[</span>root@m01ly ~<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># rpm -ivh kibana-7.8.0-x86_64.rpm</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p><img src="/2020/09/11/install-guide-elk-suricata/1603808067228.png" alt="1603808067228"></p><p>搜索rpm包</p><pre class="line-numbers language-bash"><code class="language-bash">rpm -ql kibana<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>默认是装在/usr/share/kibana/下。</p><h3 id="3-3-2修改kibana-yml"><a href="#3-3-2修改kibana-yml" class="headerlink" title="3.3.2修改kibana.yml"></a>3.3.2修改kibana.yml</h3><p>修改kibana的配置文件</p><pre class="line-numbers language-bash"><code class="language-bash"><span class="token function">vi</span> /etc/kibana/kibana.yml <span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>内容如下：</p><pre class="line-numbers language-bash"><code class="language-bash"><span class="token comment" spellcheck="true">#kibana页面映射在5601端口 </span>
server.port: 5601 
<span class="token comment" spellcheck="true">#允许所有ip访问5601端口 </span>
server.host: <span class="token string">"0.0.0.0"</span> 
<span class="token comment" spellcheck="true">#elasticsearch所在的ip及监听的地址 </span>
elasticsearch.hosts: <span class="token punctuation">[</span><span class="token string">"http://localhost:9200"</span><span class="token punctuation">]</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="3-4-3启动kibana"><a href="#3-4-3启动kibana" class="headerlink" title="3.4.3启动kibana"></a>3.4.3启动kibana</h3><pre class="line-numbers language-bash"><code class="language-bash">systemctl start kibana <span class="token comment" spellcheck="true">#启动</span>
systemctl status kibana<span class="token comment" spellcheck="true">#查看状态</span>
systemctl <span class="token function">enable</span> kibana<span class="token comment" spellcheck="true">#设置开机启动</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>kibana启动成功的界面</p><p><img src="/2020/09/11/install-guide-elk-suricata/1603808420430.png" alt="1603808420430"></p><h3 id="3-4-4-卸载"><a href="#3-4-4-卸载" class="headerlink" title="3.4.4 卸载"></a>3.4.4 卸载</h3><pre class="line-numbers language-bash"><code class="language-bash">yum remove kibana
<span class="token function">find</span> / -name kibana
<span class="token function">sudo</span> <span class="token function">rm</span> -rf /etc/kibana \
/var/lib/kibana \
/usr/share/elasticsearch/modules/kibana \
/usr/share/kibana \
/usr/share/logstash/modules/fb_apache/configuration/kibana \
/usr/share/logstash/modules/netflow/configuration/kibana \
/usr/share/logstash/x-pack/modules/arcsight/configuration/kibana \
/usr/share/logstash/x-pack/modules/azure/configuration/kibana<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="3-5-相关配置总结"><a href="#3-5-相关配置总结" class="headerlink" title="3.5 相关配置总结"></a>3.5 相关配置总结</h2><pre class="line-numbers language-bash"><code class="language-bash"><span class="token comment" spellcheck="true">##suricata</span>
/var/log/suricata/ <span class="token comment" spellcheck="true">#日志目录</span>

<span class="token comment" spellcheck="true">##elk日志目录log:</span>
<span class="token function">tail</span> -n 20  /var/log/messages 

<span class="token comment" spellcheck="true">##ES:/usr/share/elasticsearch</span>
/usr/share/elasticsearch/bin/elasticsearch<span class="token comment" spellcheck="true">#安装目录</span>
<span class="token function">egrep</span> -v <span class="token string">"^#|^$"</span> /etc/elasticsearch/elasticsearch.yml
<span class="token function">vi</span> /etc/elasticsearch/elasticsearch.yml
path.data: /var/lib/elasticsearch
path.logs: /var/log/elasticsearch

<span class="token comment" spellcheck="true">##logstash:</span>
/usr/share/logstash/bin/logstash<span class="token comment" spellcheck="true">#安装目录</span>
path.data: /var/lib/logstash
pipeline.ordered: auto
path.logs: /var/log/logstash
<span class="token function">egrep</span> -v <span class="token string">"^#|^$"</span> /etc/logstash/conf.d/logstash.conf
/etc/logstash/logstash.yml 

<span class="token comment" spellcheck="true">##kibana:</span>
/usr/share/kibana/bin/kibana<span class="token comment" spellcheck="true">#安装目录</span>
<span class="token function">egrep</span> -v <span class="token string">"^#|^$"</span> /etc/kibana/kibana.yml <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h1 id="4-在线模式部署"><a href="#4-在线模式部署" class="headerlink" title="4 在线模式部署"></a>4 在线模式部署</h1><p>在线模式部署：即suricata实时处理其他机器镜像过来的流量。然后elk进行数据化展示。</p><p>依次开启kibana elasticsearch logstash，这里需要注意的是logstash不能采用默认开启方式systemctl start logstash，因为默认配置不加载/etc/logstash/conf.d/logstash.conf文件，则加载不成功suricata日志。具体命令如下：</p><pre><code>systemctl start kibana logstash elasticsearch
systemctl start logstash#错误开启，不会加载配置文件/etc/logstash/conf.d/logstash.conf
nohup /usr/share/logstash/bin/logstash -f /etc/logstash/conf.d/logstash.conf &amp; #指定配置文件开启logstash  正确操作
sudo nohup /usr/local/bin/suricata -c /etc/suricata/suricata.yaml -i eth0 --init-errors-fatal &amp;  #启动suricata</code></pre><p>开启成功后，访问kibina,可以看到suricata日志数据。</p><p><img src="/2020/09/11/install-guide-elk-suricata/1603951881328.png" alt="1603951881328"></p><h1 id="5-离线模式部署"><a href="#5-离线模式部署" class="headerlink" title="5 离线模式部署"></a>5 离线模式部署</h1><h2 id="5-1-suricata分析流量包功能"><a href="#5-1-suricata分析流量包功能" class="headerlink" title="5.1 suricata分析流量包功能"></a>5.1 suricata分析流量包功能</h2><p>分析单个包：suricata -r pcap文件名 -l 自定义输出位置</p><p>分析文件夹里所以的包：suricata -r pcap文件夹名 -l 自定义输出位置</p><pre class="line-numbers language-bash"><code class="language-bash"><span class="token function">sudo</span> /usr/local/bin/suricata -c /etc/suricata/suricata.yaml -r /tmp/test.cap -l  /var/log/suricata/cap<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h2 id="5-2-离线模式工作原理"><a href="#5-2-离线模式工作原理" class="headerlink" title="5.2 离线模式工作原理"></a>5.2 离线模式工作原理</h2><p>离线模式工作原理：离线一词即，流量收集集群将抓取的流量scp定时发送到ids主机，然后ids主机定时启动suricata -r分析cap流量文件，然后推送到elk进行展示。该过程涉及两个部分。其中定时采用linux的crontab。</p><p>（1）流量收集集群定时推送流量文件到ids主机</p><p>定时推送流量到ids主机脚本send.sh如下：</p><pre class="line-numbers language-bash"><code class="language-bash"><span class="token shebang important">#!/bin/bash</span>
<span class="token function">scp</span> -Rf /root/testdir/ wasadmin@10.127.40.25:/root/temp/<span class="token comment" spellcheck="true">#复制到ids文件夹/root/temp/</span>
<span class="token function">rm</span> -rf /root/testdir/*<span class="token comment" spellcheck="true">#删除该主机文件夹下的所有文件</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>（2）ids主机定时分析</p><p>ids主机定时分析脚本如下suricara.sh：</p><pre class="line-numbers language-bash"><code class="language-bash">suricata -c /etc/suricata/suricata.yaml -r /root/temp/
<span class="token function">rm</span> -rf /root/temp/*<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>定时执行suricara.sh，在终端输入以下命令：</p><pre class="line-numbers language-bash"><code class="language-bash"><span class="token function">crontab</span> -e<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>在显示的文件末尾添加以下规则：#每5分钟运行一次time.sh脚本,并把错误和正确的日志都存到/tmp/load.log上。</p><pre class="line-numbers language-bash"><code class="language-bash">*/5 * * * * /root/time.sh <span class="token operator">></span> /tmp/load.log 2<span class="token operator">></span><span class="token operator">&amp;</span>1<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>编辑完成，保存完成以后，就会显示以下提示信息：</p><pre class="line-numbers language-bash"><code class="language-bash">crontab: installing new <span class="token function">crontab</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>这就说明正在安装新的定时任务，如果没有这条提示信息，请重新运行<code>crontab -e</code>命令。</p><p><img src="/2020/09/11/install-guide-elk-suricata/1604578836302-1611127871322.png" alt="1604578836302"></p><h1 id="错误解决"><a href="#错误解决" class="headerlink" title="错误解决"></a>错误解决</h1><p><img src="/2020/09/11/install-guide-elk-suricata/1603938736430.png" alt="1603938736430"></p><p><a target="_blank" rel="noopener" href="https://blog.csdn.net/weixin_44105991/article/details/91320644">Solution</a>：</p><p>1 先执行命令 <code>free -m</code> 查看内存是不是还有 最主要的是 看有没有交换空间 swap</p><p>2 创建swapfile：<code>dd if=/dev/zero of=swapfile bs=1024 count=500000</code></p><p>3 将swapfile设置为swap空间 mkswap swapfile</p><p>4 启用交换空间 swapon swapfile ( 删除交换空间是<code>swapoff swapfile</code> )</p><pre><code>free -m
dd if=/dev/zero of=swapfile bs=1024 count=500000
mkswap swapfile 
swapon swapfile 
free -m</code></pre><h1 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h1><p><a target="_blank" rel="noopener" href="https://redmine.openinfosecfoundation.org/projects/suricata/wiki/_Logstash_Kibana_and_Suricata_JSON_output">官网suricata+elk部署指南</a></p><p><a target="_blank" rel="noopener" href="https://www.elastic.co/cn/downloads/">elk官方下载连接</a></p><p><a target="_blank" rel="noopener" href="http://www.justdojava.com/2019/08/11/elk-install/">elk部署教程</a> 简单清晰</p><p><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/64742715">suricata+elk其他部署方式</a></p><p><a target="_blank" rel="noopener" href="https://developer.ibm.com/zh/articles/os-cn-elk-filebeat/">elk架构+filebeat解析</a></p><p><a target="_blank" rel="noopener" href="https://developer.ibm.com/zh/articles/os-cn-elk-filebeat/">elk日志收集教程</a></p><p><a target="_blank" rel="noopener" href="https://aws.amazon.com/cn/blogs/china/using-vpc-traffic-mirroring-to-construct-network-intrusion-detection-system-update/">借助 VPC Traffic Mirroring 构建网络入侵检测系统</a> 实时分析流量</p><p><a target="_blank" rel="noopener" href="https://www.freebuf.com/articles/network/249549.html">elk+suricata(docker部署)</a></p><link href="//src.wangriyu.wang/lib/Aplayer/APlayer.min.css" rel="stylesheet"><script src="//src.wangriyu.wang/lib/Aplayer/APlayer.min.js"></script><div id="aplayer"></div><script src="/js/player.js"></script></div><div class="article-info article-info-index"><div class="article-count"><div class="article-tag tagcloud"><ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E5%AE%89%E8%A3%85%E6%95%99%E7%A8%8B/" rel="tag">安装教程</a></li></ul></div><span class="post-count">总字数3.2k</span> <span class="post-count">预计阅读14分钟</span></div><div class="clearfix"></div></div></div></article><article id="post-install-guide-suricata" class="article article-type-post" itemscope itemprop="blogPost"><div class="article-meta"><a href="/2020/09/11/install-guide-suricata/" class="article-date"><time class="published" datetime="2020-09-11T09:59:18.000Z" itemprop="datePublished">2020-09-11 发布</time> <time class="updated" datetime="2021-01-20T07:42:01.153Z" itemprop="dateUpdated">2021-01-20 更新</time></a></div><div class="article-inner"><input type="hidden" class="isFancy"><header class="article-header"><h1 itemprop="name"><a class="article-title" href="/2020/09/11/install-guide-suricata/">centos7中安装suricata</a></h1></header><div class="article-entry" itemprop="articleBody"><p>官网： <a target="_blank" rel="noopener" href="https://suricata-ids.org/">https://suricata-ids.org/</a></p><p>官网安装教程： <a target="_blank" rel="noopener" href="https://redmine.openinfosecfoundation.org/projects/suricata/wiki/Suricata_Installation">https://redmine.openinfosecfoundation.org/projects/suricata/wiki/Suricata_Installation</a></p><p>centos官网安装教程： <a target="_blank" rel="noopener" href="https://redmine.openinfosecfoundation.org/projects/suricata/wiki/CentOS_Installation">https://redmine.openinfosecfoundation.org/projects/suricata/wiki/CentOS_Installation</a></p><h1 id="一安装教程"><a href="#一安装教程" class="headerlink" title="一安装教程"></a>一安装教程</h1><p>操作系统：Centos7</p><p>安装版本：suricata6.0.0</p><p>1)安装wget</p><pre class="line-numbers language-bash"><code class="language-bash"><span class="token punctuation">[</span>root@suricata~<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># yum install wget -y</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>2)更换源</p><p>　　更换成阿里云源，更新系统、下载软件速度快</p><pre class="line-numbers language-bash"><code class="language-bash"><span class="token punctuation">[</span>root@suricata~<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># mv /etc/yum.repos.d/CentOS-Base.repo /etc/yum.repos.d/CentOS-Base.repo.backup</span>
<span class="token punctuation">[</span>root@suricata~<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># wget -O /etc/yum.repos.d/CentOS-Base.repo http://mirrors.aliyun.com/repo/Centos-7.repo</span>
<span class="token punctuation">[</span>root@suricata~<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># yum clean all</span>
<span class="token punctuation">[</span>root@suricata~<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># yum makecache</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p>3)更新系统</p><pre class="line-numbers language-bash"><code class="language-bash"><span class="token punctuation">[</span>root@m01ly~<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># yum -y update</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p><img src="/2020/09/11/install-guide-suricata/1603261907715.png" alt="1603261907715"></p><p>4)安装epel</p><pre class="line-numbers language-bash"><code class="language-bash"><span class="token punctuation">[</span>root@m01ly ~<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># yum install epel-release</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p><img src="/2020/09/11/install-guide-suricata/1603261947721.png" alt="1603261947721"></p><p>5)安装相关依赖</p><pre class="line-numbers language-bash"><code class="language-bash"><span class="token punctuation">[</span>root@m01ly ~<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># sudo yum -y install gcc libpcap-devel pcre-devel libyaml-devel file-devel \</span>
zlib-devel jansson-devel nss-devel libcap-ng-devel libnet-devel <span class="token function">tar</span> <span class="token function">make</span> \
libnetfilter_queue-devel lua-devel PyYAML libmaxminddb-devel rustc cargo \
lz4-devel<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p><img src="/2020/09/11/install-guide-suricata/1603262215276.png" alt="1603262215276"></p><p>6)开始安装suricata</p><p>这里尝试安装官网<a target="_blank" rel="noopener" href="https://www.openinfosecfoundation.org/download/suricata-6.0.0.tar.gz">最新6.0版本</a></p><p><a target="_blank" rel="noopener" href="https://suricata-ids.org/download/">https://suricata-ids.org/download/</a></p><p><img src="/2020/09/11/install-guide-suricata/1603262265601.png" alt="1603262265601"></p><p>下载安装包，进行解压配置安装：</p><pre class="line-numbers language-bash"><code class="language-bash"><span class="token punctuation">[</span>root@m01ly ~<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># wget https://www.openinfosecfoundation.org/download/suricata-6.0.0.tar.gz</span>
<span class="token punctuation">[</span>root@m01ly ~<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># tar -xvzf suricata-6.0.0.tar.gz</span>
<span class="token punctuation">[</span>root@m01ly ~<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># cd suricata-6.0.0</span>
<span class="token punctuation">[</span>root@m01ly suricata-6.0.0<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># ./configure --prefix=/usr --sysconfdir=/etc --localstatedir=/var --enable-nfqueue --enable-lua</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p><img src="/2020/09/11/install-guide-suricata/1603262683253.png" alt="1603262683253"></p><p>之后再编译安装</p><pre class="line-numbers language-bash"><code class="language-bash"><span class="token punctuation">[</span>root@m01ly suricata-6.0.0<span class="token punctuation">]</span><span class="token comment" spellcheck="true">#make</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><pre class="line-numbers language-bash"><code class="language-bash"><span class="token punctuation">[</span>root@m01ly suricata-6.0.0<span class="token punctuation">]</span><span class="token comment" spellcheck="true">#sudo make install</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p><img src="/2020/09/11/install-guide-suricata/1603878275030.png" alt="1603878275030"></p><pre class="line-numbers language-bash"><code class="language-bash"><span class="token punctuation">[</span>root@m01ly suricata-6.0.0<span class="token punctuation">]</span><span class="token comment" spellcheck="true">#sudo ldconfig</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>之后进行一些配置：</p><p>（1）自动为您创建/设置所有必需的目录和suricata.yaml：</p><pre><code>[root@m01ly suricata-6.0.0]#make install-conf</code></pre><p>（2） 自动配置规则集</p><pre><code>[root@m01ly suricata-6.0.0]#make install-rules</code></pre><p>将执行常规的“ make install”，然后它将自动从Suricata的“ Emerging Threats ”中下载并设置最新规则集</p><p>（3）将结合上述所有内容（install-conf和install-rules）-并为您提供可以运行（配置和设置）的Suricata</p><pre><code>[root@m01ly suricata-6.0.0]#make install-full</code></pre><p>安装完成后，安装目录为：/etc/suricata，配置文件为/etc/suricata/suricata.yaml</p><h1 id="二-基础配置"><a href="#二-基础配置" class="headerlink" title="二 基础配置"></a>二 基础配置</h1><p>按照<a target="_blank" rel="noopener" href="https://redmine.openinfosecfoundation.org/projects/suricata/wiki/Basic_Setup">官方基础配置</a>一步步就可。注意图中的cp指令一块不需要操作，6.0版本自动会复制。<img src="/2020/09/11/install-guide-suricata/1603693471544.png" alt="1603693471544"></p><p>(1) 创建目录</p><pre class="line-numbers language-bash"><code class="language-bash"><span class="token function">sudo</span> <span class="token function">mkdir</span> /var/log/suricata
<span class="token function">sudo</span> <span class="token function">mkdir</span> /etc/suricata<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><pre><code>[root@ids0001 suricata-5.0.0]# cd etc
[root@ids0001 etc]# ls
classification.config  Makefile.am  reference.config    suricata.logrotate.in  suricata.service.in
Makefile               Makefile.in  suricata.logrotate  suricata.service
[root@ids0001 etc]# sudo cp classification.config /etc/suricata
[root@ids0001 etc]# sudo cp reference.config /etc/suricata</code></pre><p><img src="/2020/09/11/install-guide-suricata/1603855808097.png" alt="1603855808097"></p><pre><code>./configure &amp;&amp; make &amp;&amp; make install-conf</code></pre><p>需要一段时间，最后结果：</p><p><img src="/2020/09/11/install-guide-suricata/1603878960614.png" alt="1603878960614"></p><p>自动下载和设置从正在出现的威胁可Suricata最新的规则集。</p><p>./configure &amp;&amp; make &amp;&amp; make install-rules</p><p>需要又一段时间，最后结果：</p><p>./configure &amp;&amp; make &amp;&amp; make install-full</p><h2 id="2-1-基础配置"><a href="#2-1-基础配置" class="headerlink" title="2.1 基础配置"></a>2.1 基础配置</h2><p>配置文件位于**/etc/suricata/suricata.yaml**。用VIM打开</p><pre class="line-numbers language-bash"><code class="language-bash"><span class="token punctuation">[</span>root@m01ly ~<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># cd /etc/suricata/</span>
<span class="token punctuation">[</span>root@m01ly suricata<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># vim suricata.yaml</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>（1）配置要拦截的流量设置</p><p>在“vars”部分下，您将找到Suricata使用的几个重要变量。</p><p>“HOME_NET”应指向Suricata要检查的本地网络。</p><p>“！$ HOME_NET”（分配给EXTERNAL_NET）是指除本地网络之外的任何其他网络。</p><p>“XXX_PORTS”表示不同服务使用的端口号。请注意，无论使用何种端口，Suricata都可以自动检测HTTP流量。因此，正确指定HTTP_PORTS变量并不重要。</p><p>先设置HOME_NET与EXTERNAL_NET，推荐HOME_NET填写内网网段，EXTERNAL_NET设置为any</p><p>注意如果HOME_NET设置了any，EXTERNAL_NET设置！HOME_NET的话会报错，如果HOME_NET设置了内网地址，EXTERNAL_NET设置为！$HOME_NET的话，有些内网之间的告警就无法匹配到</p><p><img src="/2020/09/11/install-guide-suricata/1603708931016.png" alt="1603708931016"></p><p>（2）指定日志文件目录</p><p><img src="/2020/09/11/install-guide-suricata/1603708864025.png" alt="1603708864025"></p><p>（3） host-os-policy 配置，在文件百分之60处。</p><p>“host-os-policy”部分用于防御一些众所周知的攻击，这些攻击利用操作系统的网络堆栈（例如，TCP重组）的行为来逃避检测。作为对策，现代IDS提出了所谓的“基于目标”的检查，其中检查引擎基于流量的目标操作系统微调其检测算法。因此，如果您知道正在运行的OS个别本地主机，您可以将该信息提供给Suricata以提高其检测率。</p><p><img src="/2020/09/11/install-guide-suricata/1603709095833.png" alt="1603709095833"></p><p>（4）线程</p><p>在“线程”部分下，您可以为不同的Suricata线程指定CPU关联。默认情况下，禁用CPU关联（“set-cpu-affinity：no”），这意味着将在任何可用的CPU核心上调度Suricata线程。默认情况下，Suricata将为每个CPU核心创建一个“检测”线程。您可以通过指定“detect-thread-ratio：N”来调整此行为。这将创建N * M个检测线程，其中M是主机上CPU核心的总数。</p><p>使用上述线程设置，Suricata将创建1.5 * M检测线程，其中M是系统上CPU核心的总数。</p><h2 id="2-2-启动"><a href="#2-2-启动" class="headerlink" title="2.2 启动"></a>2.2 启动</h2><h3 id="2-2-1-关闭-LRO-GRO"><a href="#2-2-1-关闭-LRO-GRO" class="headerlink" title="2.2.1 关闭 LRO / GRO"></a>2.2.1 关闭 LRO / GRO</h3><p>当您使用<code>pcap</code>捕获模式时，强烈建议关闭Suricata正在侦听的NIC上的任何数据包offloead功能（例如，LRO / GRO），因为这些功能可能会干扰实时数据包捕获。</p><p>以下是如何在网络接口eth0上关闭LRO / GRO：</p><pre><code>[root@m01ly ~]# sudo ethtool -K ens33 gro off lro off</code></pre><h3 id="2-2-2-测试是否配置成功："><a href="#2-2-2-测试是否配置成功：" class="headerlink" title="2.2.2 测试是否配置成功："></a>2.2.2 测试是否配置成功：</h3><pre class="line-numbers language-bash"><code class="language-bash"><span class="token punctuation">[</span>root@m01ly ~<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># suricata -T</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p><img src="/2020/09/11/install-guide-suricata/1603697120852.png" alt="1603697120852"></p><h3 id="2-2-3-运行模式"><a href="#2-2-3-运行模式" class="headerlink" title="2.2.3  运行模式"></a>2.2.3 运行模式</h3><p>Suricata支持多种运行模式。运行模式确定不同线程如何用于IDS。以下命令列出了所有<a target="_blank" rel="noopener" href="https://redmine.openinfosecfoundation.org/projects/suricata/wiki/Runmodes">可用的runmodes</a>。</p><pre class="line-numbers language-bash"><code class="language-bash"><span class="token punctuation">[</span>root@m01ly ~<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># sudo /usr/local/bin/suricata --list-runmodes</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>Suricata使用的默认运行模式是<code>autofp</code>（代表“自动流固定负载平衡”）。在此模式下，来自每个不同流的数据包将分配给单个检测线程。将流分配给具有最少数量的未处理数据包的线程。</p><h3 id="2-2-4-启动suricata"><a href="#2-2-4-启动suricata" class="headerlink" title="2.2.4 启动suricata"></a>2.2.4 启动suricata</h3><p>启动命令：sudo suricata -c 启动文件 -i 网卡名称 –init-errors-fatal：例如下面</p><pre class="line-numbers language-bash"><code class="language-bash"><span class="token punctuation">[</span>root@suricata ~<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># sudo /usr/local/bin/suricata -c /etc/suricata/suricata.yaml    -i ens33   -s /etc/suricata/rules/test.rules</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><pre class="line-numbers language-bash"><code class="language-bash"><span class="token punctuation">[</span>root@m01ly ~<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># sudo /usr/local/bin/suricata -c /etc/suricata/suricata.yaml -i eth0 --init-errors-fatal</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p><img src="/2020/09/11/install-guide-suricata/1603709547401.png" alt="1603709547401"></p><p>后台启用：</p><pre class="line-numbers language-bash"><code class="language-bash"><span class="token punctuation">[</span>root@m01ly ~<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># sudo nohup /usr/local/bin/suricata -c /etc/suricata/suricata.yaml -i eth0 --init-errors-fatal &amp;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h3 id="2-2-5-查看日志"><a href="#2-2-5-查看日志" class="headerlink" title="2.2.5 查看日志"></a>2.2.5 查看日志</h3><p>Suricata检测日志存储在/ var / log / suricata目录中。</p><p>其中fast.log表示命中规则的日志。</p><pre class="line-numbers language-bash"><code class="language-bash"><span class="token punctuation">[</span>root@m01ly ~<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># tail -f /var/log/suricata/fast.log</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p><img src="/2020/09/11/install-guide-suricata/1603713977753.png" alt="1603713977753"></p><p>为了便于导入，日志也以json格式提供：</p><pre class="line-numbers language-bash"><code class="language-bash"><span class="token punctuation">[</span>root@m01ly ~<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># tail -f /var/log/suricata/eve.json</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p><img src="/2020/09/11/install-guide-suricata/1603714049656.png" alt="1603714049656"></p><h1 id="三-规则管理"><a href="#三-规则管理" class="headerlink" title="三 规则管理"></a>三 规则管理</h1><h2 id="3-1-规则介绍"><a href="#3-1-规则介绍" class="headerlink" title="3.1 规则介绍"></a>3.1 规则介绍</h2><h3 id="3-1-1-规则集"><a href="#3-1-1-规则集" class="headerlink" title="3.1.1 规则集"></a>3.1.1 规则集</h3><p>suricata系统自带的规则主要是et/open 规则，目前开源免费的就是et/open、pt规则、sslbl规则，其余的需要授权码才能更新，如下：</p><ol><li><a target="_blank" rel="noopener" href="https://github.com/jasonish/suricata-trafficid/blob/master/rules/traffic-id.rules">Suricata作者写的一个规则生成的脚本</a>：生成用于应用和服务识别的规则。</li><li><a target="_blank" rel="noopener" href="https://sslbl.abuse.ch/blacklist/sslblacklist.rule">瑞士的非盈利组织abuse.ch维护的项目</a>：他们维护的这个黑名单是标识恶意软件与僵尸网络相关的，列表里面提供了有关恶意软件与僵尸网络的ssl证书列表，根据证书特征来匹配流量中的威胁。他们提供了一个Suricata的规则，可以根据黑名单检测网络中的恶意连接。</li><li><a target="_blank" rel="noopener" href="https://github.com/ptresearch/AttackDetection">PT的Suricata规则库</a>：根据恶意软件、黑客的网络通讯协议以及漏洞的poc去编写，里面包含了近几年常见cve漏洞的检测，更新十分及时。</li><li><a target="_blank" rel="noopener" href="https://rules.emergingthreats.net/open/suricata/rules/">Emerging Threats维护的规则</a>：这个就比较熟悉了，我们一般常用的就是这个规则库。很强大的规则库，规则数量有20000+ 。<a target="_blank" rel="noopener" href="http://doc.emergingthreats.net/bin/view/Main/EmergingFAQ#What_is_the_general_intent_of_ea">官方规则解释</a></li></ol><h3 id="3-1-2-规则管理工具"><a href="#3-1-2-规则管理工具" class="headerlink" title="3.1.2 规则管理工具"></a>3.1.2 规则管理工具</h3><p>规则管理，就是便于对suricata的规则进行统一的管理，比如更新、启用、停用等。相关的规则管理工具有很多，简单列举几个：</p><ul><li><a target="_blank" rel="noopener" href="https://github.com/jasonish/suricata-update">Suricata-Update</a> ：常用工具</li><li><a target="_blank" rel="noopener" href="https://github.com/StamusNetworks/scirius">Scirius</a>：Scirius是个管理Suricata规则集的Web应用。搭建和使用也不难，参见github。</li><li><a target="_blank" rel="noopener" href="https://www.jianshu.com/p/1a96770695db">Oinkmaster</a></li><li><a target="_blank" rel="noopener" href="https://github.com/shirkdog/pulledpork">Pulledpork：</a></li></ul><h2 id="3-2-规则更新"><a href="#3-2-规则更新" class="headerlink" title="3.2 规则更新"></a>3.2 规则更新</h2><p>suricata规则更新可以使用suricata-update来进行更新, 输入suricata-update 会自动进行规则更新，显示当前已经更新与启用了多少规则</p><h3 id="3-2-1-更新规则库"><a href="#3-2-1-更新规则库" class="headerlink" title="3.2.1 更新规则库"></a>3.2.1 更新规则库</h3><pre class="line-numbers language-bash"><code class="language-bash"><span class="token punctuation">[</span>root@m01ly ~<span class="token punctuation">]</span><span class="token comment" spellcheck="true">#suricata-update</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>最近的一次更新结果如下，规则总数为28178条：</p><p><img src="/2020/09/11/install-guide-suricata/1603697024470.png" alt="1603697024470"></p><p>规则更新后，所有的规则都会保存在/var/lib/suricata/rules/suricata.rules这一个文件中，这个时候就必须修改suricata配置文件suricata.yaml的default-rule-path与rule-files来指定规则文件到这个规则上:</p><pre class="line-numbers language-bash"><code class="language-bash">default-rule-path: /var/lib/suricata/rules
rule-files:
  - suricata.rules<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><h3 id="3-2-2-更新规则源"><a href="#3-2-2-更新规则源" class="headerlink" title="3.2.2 更新规则源"></a>3.2.2 更新规则源</h3><p>（1）更新规则源：</p><pre class="line-numbers language-bash"><code class="language-bash"><span class="token punctuation">[</span>root@m01ly ~<span class="token punctuation">]</span><span class="token comment" spellcheck="true">#suricata-update update-sources</span>
<span class="token punctuation">[</span>root@m01ly ~<span class="token punctuation">]</span><span class="token comment" spellcheck="true">#suricata-update</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p><img src="/2020/09/11/install-guide-suricata/1603700557845.png" alt="1603700557845"></p><p>（2）列出更新源列表 suricata-update list-sources</p><p><img src="/2020/09/11/install-guide-suricata/1603697274919.png" alt="1603697274919"></p><p>每个规则集都有一个前缀为“vendor”的名称，后跟一个集名称。例如，iosf的traffic id规则集称为“iosf/trafficid”。</p><h3 id="3-2-3-启用某个规则集"><a href="#3-2-3-启用某个规则集" class="headerlink" title="3.2.3 启用某个规则集"></a>3.2.3 启用某个规则集</h3><p>要启用ptresearch/attackdetection的规则集：</p><pre class="line-numbers language-bash"><code class="language-bash"><span class="token punctuation">[</span>root@m01ly ~<span class="token punctuation">]</span><span class="token comment" spellcheck="true">#suricata-update enable-source ptresearch/attackdetection</span>
<span class="token punctuation">[</span>root@m01ly ~<span class="token punctuation">]</span><span class="token comment" spellcheck="true">#suricata-update</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p><img src="/2020/09/11/install-guide-suricata/1603700718529.png" alt="1603700718529"></p><h3 id="3-2-4-禁用规则"><a href="#3-2-4-禁用规则" class="headerlink" title="3.2.4 禁用规则"></a>3.2.4 禁用规则</h3><p>使用Suricata-update更新规则时，默认是将所有规则合并在一个规则文件中：/var/lib/suricata/rules/suricata.rules。</p><p><img src="/2020/09/11/install-guide-suricata/1603705089676.png" alt="1603705089676"></p><p>Suricata-update有个 –no-merge参数，使用这个参数更新规则，规则不会进行合并，是以独立的文件存在于文件夹下。但是在管理规则的时候很不方便，必须要自己管理Suricata引入的规则。但是在禁用规则的时候，也可以使用suricata-update去配置disable.conf禁用的规则。不推荐使用 –no-merge参数更新规则。指定一个文件让suricata-update合并输出会更简单。在suricata.yaml中修改default-rule-path和rule-files。</p><p><img src="/2020/09/11/install-guide-suricata/1603708490301.png" alt="1603708490301"></p><p>通过suricata-udpate可以很好的控制规则，例如要禁用某一个规则，直接新建/etc/suricata/disable.conf 文件，然后在里面填入sid，每次更新的话会自动禁止该规则</p><p>默认情况下 <code>suricata-update</code> 将所有规则合并到一个文件“/var/lib/suricata/rules”/苏里克塔规则”.</p><p>要启用默认禁用的规则，请使用 /etc/suricata/enable.conf</p><pre><code>2019401                   # enable signature with this sid
group:emerging-icmp.rules # enable this rulefile
re:trojan                 # enable all rules with this string</code></pre><p>类似地，要禁用规则，请使用 /etc/suricata/disable.conf ：</p><pre class="line-numbers language-bash"><code class="language-bash">2019401                   <span class="token comment" spellcheck="true"># disable signature with this sid</span>
group:emerging-info.rules <span class="token comment" spellcheck="true"># disable this rulefile</span>
re:heartbleed             <span class="token comment" spellcheck="true"># disable all rules with this string</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>更新这些文件后，</p><pre class="line-numbers language-bash"><code class="language-bash"><span class="token punctuation">[</span>root@m01ly ~<span class="token punctuation">]</span><span class="token comment" spellcheck="true">#suricata-update --disable-conf /etc/suricata/disable.conf</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>重新运行 <code>suricata-update</code> 再一次：</p><pre class="line-numbers language-bash"><code class="language-bash"><span class="token punctuation">[</span>root@m01ly ~<span class="token punctuation">]</span><span class="token comment" spellcheck="true">#sudo suricata-update</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>最后重新开始测量。</p><h2 id="3-5-规则源的CRUD"><a href="#3-5-规则源的CRUD" class="headerlink" title="3.5 规则源的CRUD"></a>3.5 规则源的CRUD</h2><h3 id="3-5-1-列出我们使用的规则源"><a href="#3-5-1-列出我们使用的规则源" class="headerlink" title="3.5.1 列出我们使用的规则源"></a>3.5.1 列出我们使用的规则源</h3><pre class="line-numbers language-bash"><code class="language-bash"><span class="token punctuation">[</span>root@m01ly ~<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># suricata-update list-enabled-sources</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p><img src="/2020/09/11/install-guide-suricata/1603701147686.png" alt="1603701147686"></p><h3 id="3-5-2-更新规则源"><a href="#3-5-2-更新规则源" class="headerlink" title="3.5.2 更新规则源"></a>3.5.2 更新规则源</h3><pre><code>[root@m01ly ~]#suricata-update update-sources</code></pre><p><img src="/2020/09/11/install-guide-suricata/1603700557845.png" alt="1603700557845"></p><h3 id="3-5-3-删除某个规则源"><a href="#3-5-3-删除某个规则源" class="headerlink" title="3.5.3 删除某个规则源"></a>3.5.3 删除某个规则源</h3><pre class="line-numbers language-bash"><code class="language-bash"><span class="token punctuation">[</span>root@m01ly ~<span class="token punctuation">]</span><span class="token comment" spellcheck="true">#suricata-update remove-source et/pro</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h3 id="3-5-4-启动某个规则源"><a href="#3-5-4-启动某个规则源" class="headerlink" title="3.5.4 启动某个规则源"></a>3.5.4 启动某个规则源</h3><p>启用ptresearch/attackdetection的规则集：</p><pre class="line-numbers language-bash"><code class="language-bash"><span class="token punctuation">[</span>root@m01ly ~<span class="token punctuation">]</span><span class="token comment" spellcheck="true">#suricata-update enable-source ptresearch/attackdetection</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p><img src="/2020/09/11/install-guide-suricata/1603700718529.png" alt="1603700718529"></p><h2 id="3-6-规则的CRUD"><a href="#3-6-规则的CRUD" class="headerlink" title="3.6 规则的CRUD"></a>3.6 规则的CRUD</h2><p><a target="_blank" rel="noopener" href="https://suricata-update.readthedocs.io/en/latest/update.html#rule-matching">https://suricata-update.readthedocs.io/en/latest/update.html#rule-matching</a></p><h1 id="4-一个实例"><a href="#4-一个实例" class="headerlink" title="4 一个实例"></a>4 一个实例</h1><p>/var/lib/suricata/rules/下创建一个test.rules,内容为：</p><pre class="line-numbers language-bash"><code class="language-bash">alert http any any -<span class="token operator">></span> any any <span class="token punctuation">(</span>msg:<span class="token string">"hit baidu.com..."</span><span class="token punctuation">;</span>content:<span class="token string">"baidu"</span><span class="token punctuation">;</span> reference:url, www.baidu.com<span class="token punctuation">;</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>修改配置文件/etc/suricata/suricata.yaml，再规则下添test.rules</p><pre><code>#启动suricata
#sudo /usr/local/bin/suricata -c /etc/suricata/suricata.yaml    -i eth0</code></pre><p><img src="/2020/09/11/install-guide-suricata/1603858949410.png" alt="1603858949410"></p><h1 id="5-suricata-分析包功能"><a href="#5-suricata-分析包功能" class="headerlink" title="5 suricata 分析包功能"></a>5 suricata 分析包功能</h1><p>分析单个包：suricata -r pcap文件名 -l 自定义输出位置</p><p>分析文件夹里所以的包：suricata -r pcap文件夹名 -l 自定义输出位置</p><pre class="line-numbers language-bash"><code class="language-bash"><span class="token function">sudo</span> /usr/local/bin/suricata -c /etc/suricata/suricata.yaml -r /tmp/test.cap -l  /var/log/suricata/cap<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p><img src="/2020/09/11/install-guide-suricata/1603955429308.png" alt="1603955429308"></p><p><img src="/2020/09/11/install-guide-suricata/1603955464136.png" alt="1603955464136"></p><h1 id="6-卸载suricata"><a href="#6-卸载suricata" class="headerlink" title="6 卸载suricata"></a>6 卸载suricata</h1><pre><code>[root@ids0001 ~]# find / -name suricata 
/run/suricata
/etc/suricata
/root/suricata-5.0.0/python/suricata
/root/suricata-5.0.0/suricata-update/suricata
/var/lib/suricata
/var/log/suricata
/usr/bin/suricata
/usr/lib/python2.7/site-packages/suricata
/usr/share/doc/suricata
/usr/share/suricata
/usr/share/kibana/x-pack/plugins/siem/public/components/timeline/body/renderers/suricata
/usr/local/bin/suricata
/usr/local/etc/suricata
/usr/local/lib/python2.7/site-packages/suricata
/usr/local/share/suricata
/usr/local/share/doc/suricata
/usr/local/var/log/suricata
/usr/local/var/run/suricata
/usr/local/var/lib/suricata
/home/supper-user/suricata-5.0.0/src/suricata
/home/supper-user/suricata-5.0.0/src/.libs/suricata
/home/supper-user/suricata-5.0.0/python/suricata
/home/supper-user/suricata-5.0.0/python/lib/suricata
/home/supper-user/suricata-5.0.0/suricata-update/suricata
/home/supper-user/suricata-5.0.0/suricata-update/lib/suricata</code></pre><p><img src="/2020/09/11/install-guide-suricata/1603877103161.png" alt="1603877103161"></p><pre class="line-numbers language-bash"><code class="language-bash"><span class="token function">sudo</span> <span class="token function">rm</span> -rf /run/suricata \
/etc/suricata \
/root/suricata-5.0.0/python/suricata \
/root/suricata-5.0.0/suricata-update/suricata \
/var/lib/suricata \
/var/log/suricata \
/usr/bin/suricata \
/usr/lib/python2.7/site-packages/suricata \
/usr/share/doc/suricata \
/usr/share/suricata \
/usr/share/kibana/x-pack/plugins/siem/public/components/timeline/body/renderers/suricata \
/usr/local/bin/suricata \
/usr/local/etc/suricata \
/usr/local/lib/python2.7/site-packages/suricata \
/usr/local/share/suricata \
/usr/local/share/doc/suricata \
/usr/local/var/log/suricata \
/usr/local/var/run/suricata \
/usr/local/var/lib/suricata \
/home/supper-user/suricata-5.0.0/src/suricata \
/home/supper-user/suricata-5.0.0/src/.libs/suricata \
/home/supper-user/suricata-5.0.0/python/suricata \
/home/supper-user/suricata-5.0.0/python/lib/suricata \
/home/supper-user/suricata-5.0.0/suricata-update/suricata \
/home/supper-user/suricata-5.0.0/suricata-update/lib/suricata<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h1 id="7-error"><a href="#7-error" class="headerlink" title="7 error"></a>7 error</h1><p>错误1 eth0网卡不存在</p><p><img src="/2020/09/11/install-guide-suricata/1603876350581.png" alt="1603876350581"></p><pre class="line-numbers language-bash"><code class="language-bash">9:25 - <span class="token operator">&lt;</span>Warning<span class="token operator">></span> - <span class="token punctuation">[</span>ERRCODE: SC_ERR_INVALID_ARGUMENT<span class="token punctuation">(</span>13<span class="token punctuation">)</span><span class="token punctuation">]</span> - eve-log dns version not found, forcing it to version 2
28/10/2020 -- 09:09:25 - <span class="token operator">&lt;</span>Warning<span class="token operator">></span> - <span class="token punctuation">[</span>ERRCODE: SC_ERR_INVALID_ARGUMENT<span class="token punctuation">(</span>13<span class="token punctuation">)</span><span class="token punctuation">]</span> - eve-log dns version not found, forcing it to version 2
28/10/2020 -- 09:09:33 - <span class="token operator">&lt;</span>Warning<span class="token operator">></span> - <span class="token punctuation">[</span>ERRCODE: SC_ERR_SYSCALL<span class="token punctuation">(</span>50<span class="token punctuation">)</span><span class="token punctuation">]</span> - Failure when trying to <span class="token keyword">set</span> feature via ioctl <span class="token keyword">for</span> <span class="token string">'eth0'</span><span class="token keyword">:</span> Operation not supported <span class="token punctuation">(</span>95<span class="token punctuation">)</span>
28/10/2020 -- 09:09:33 - <span class="token operator">&lt;</span>Notice<span class="token operator">></span> - all 2 packet processing threads, 4 management threads initialized, engine started.<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p>错误2 内存不够</p><p><img src="/2020/09/11/install-guide-suricata/1604628379983.png" alt="1604628379983"></p><pre class="line-numbers language-bash"><code class="language-bash">root@ids0001 ~<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># suricata -T6/11/2020 -- 02:05:11 - &lt;Info> - Running suricata under test mode6/11/2020 -- 02:05:11 - &lt;Notice> - This is Suricata version 6.0.0 RELEASE running in SYSTEM mode6/11/2020 -- 02:05:21 - &lt;Error> - [ERRCODE: SC_ERR_MEM_ALLOC(1)] - SCRealloc failed: Cannot allocate memory, while trying to allocate 67108864 bytes6/11/2020 -- 02:05:22 - &lt;Error> - [ERRCODE: SC_ERR_FATAL(171)] - Out of memory. The engine cannot be initialized.Exiting...</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>重启解决</p><p>问题三：内存不够</p><p><img src="/2020/09/11/install-guide-suricata/1604629087216.png" alt="1604629087216"></p><pre class="line-numbers language-bash"><code class="language-bash">6/11/2020 -- 02:16:45 - <span class="token operator">&lt;</span>Notice<span class="token operator">></span> - This is Suricata version 6.0.0 RELEASE running <span class="token keyword">in</span> SYSTEM mode
6/11/2020 -- 02:16:54 - <span class="token operator">&lt;</span>Warning<span class="token operator">></span> - <span class="token punctuation">[</span>ERRCODE: SC_ERR_SYSCALL<span class="token punctuation">(</span>50<span class="token punctuation">)</span><span class="token punctuation">]</span> - Failure when trying to <span class="token keyword">set</span> feature via ioctl <span class="token keyword">for</span> <span class="token string">'eth0'</span><span class="token keyword">:</span> Operation not supported <span class="token punctuation">(</span>95<span class="token punctuation">)</span>
6/11/2020 -- 02:16:54 - <span class="token operator">&lt;</span>Warning<span class="token operator">></span> - <span class="token punctuation">[</span>ERRCODE: SC_ERR_INITIALIZATION<span class="token punctuation">(</span>45<span class="token punctuation">)</span><span class="token punctuation">]</span> - Unix socket: UNIX socket bind<span class="token punctuation">(</span>/usr/local/var/run/suricata/suricata-command.socket<span class="token punctuation">)</span> error: No space left on device
6/11/2020 -- 02:16:54 - <span class="token operator">&lt;</span>Error<span class="token operator">></span> - <span class="token punctuation">[</span>ERRCODE: SC_ERR_FATAL<span class="token punctuation">(</span>171<span class="token punctuation">)</span><span class="token punctuation">]</span> - Unable to create unix <span class="token function">command</span> socket<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p>8所有命令</p><pre><code>1.安装必要库
(1)检查是否安装了jansson,这是Suricata输出的日志文件eve.json必备库
可参考:彻底解决Suricata Eve-log support not compiled in 问题
(2)安装pfring
2.安装Suricata
https://suricata-ids.org/download/下载安装包
(1)解压安装包
tar -zxf suricata-4.1.0.tar.gz
(2)编译和安装
./configure -enable-pfring --with-libpfring-includes=/opt/pfring/include --with-libpfring-libraries=/opt/pfring/lib -with-libjansson libraries=/usr/lib64/ --with-libjansson-includes=/usr/include
make
make install
(3)创建必要的目录，这些目录都是suricata.yaml配置文件中写好的路径，但不会主动创建，需要手动创建
mkdir /usr/local/etc/suricata/ #配置文件目录
cp suricata-4.1.0/classification.config /usr/local/etc/suricata/
cp suricata-4.1.0/reference.config /usr/local/etc/suricata/
cp suricata-4.1.0/suricata.yaml /usr/local/etc/suricata/
cp suricata-4.1.0/threshold.config /usr/local/etc/suricata/
mkdir /usr/local/var/run/suricata
mkdir /usr/local/var/log/suricata/ #suricata默认日志输出位置
(4)离线安装规则
在https://rules.emergingthreats.net/open/,中下载emerging.rules.tar.gz
tar -zxf emerging.rules.tar.gz
rm -rf /usr/local/share/suricata/rules
mv rules /usr/local/share/suricata/
(5)运行suricata
/usr/local/bin/suricata --pfring-int=em1 --pfring-cluster-id=99 --pfring-cluster-type=cluster_flow -c /usr/local/etc/suricata/suricata.yaml -D
(6)输出的日志的类型可以在suricata.yaml中进行设置</code></pre><h1 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h1><p><a target="_blank" rel="noopener" href="https://www.jianshu.com/p/d81db4c352af">Suricata默认规则集的目的与用途</a> nice</p><p><a target="_blank" rel="noopener" href="https://suricata-update.readthedocs.io/en/latest/">suricata-update的官方文档：</a> 规则工具的官网文档 <a target="_blank" rel="noopener" href="https://www.osgeo.cn/suricata/rule-management/suricata-update.html">https://www.osgeo.cn/suricata/rule-management/suricata-update.html</a></p><p><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/36340468">Suricata规则介绍、以及使用suricata-update做规则管理</a></p><p><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/37173608">Suricata IDS 入门 — 规则详解</a> 比较详细</p><p><a target="_blank" rel="noopener" href="https://suricata.readthedocs.io/en/suricata-6.0.0/">suricata官方6.0 文档</a></p><p><a target="_blank" rel="noopener" href="https://suricata-update.readthedocs.io/en/latest/update.html#rule-matching">规则的CRUD</a></p><p><a target="_blank" rel="noopener" href="http://www.hyuuhit.com/2018/02/11/suricata-config/">suricata命令行参数</a></p><p><a target="_blank" rel="noopener" href="https://www.osgeo.cn/suricata/command-line-options.html">suricata命令行参数2</a></p><p><a target="_blank" rel="noopener" href="https://www.yuque.com/dekeshile/pkiul1/rrlufv">suricata笔记</a> 不错，较全面</p><p><a target="_blank" rel="noopener" href="https://www.yuque.com/dekeshile/pkiul1/rrlufv">suricata较完整的功能列表</a> 后续继续学习</p><link href="//src.wangriyu.wang/lib/Aplayer/APlayer.min.css" rel="stylesheet"><script src="//src.wangriyu.wang/lib/Aplayer/APlayer.min.js"></script><div id="aplayer"></div><script src="/js/player.js"></script></div><div class="article-info article-info-index"><div class="article-count"><div class="article-tag tagcloud"><ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E5%AE%89%E8%A3%85%E6%95%99%E7%A8%8B/" rel="tag">安装教程</a></li></ul></div><span class="post-count">总字数3.8k</span> <span class="post-count">预计阅读17分钟</span></div><div class="clearfix"></div></div></div></article><article id="post-pt-sqlbypass" class="article article-type-post" itemscope itemprop="blogPost"><div class="article-meta"><a href="/2020/09/10/pt-sqlbypass/" class="article-date"><time class="published" datetime="2020-09-10T08:35:30.000Z" itemprop="datePublished">2020-09-10 发布</time> <time class="updated" datetime="2021-02-18T07:06:32.823Z" itemprop="dateUpdated">2021-02-18 更新</time></a></div><div class="article-inner"><input type="hidden" class="isFancy"><header class="article-header"><h1 itemprop="name"><a class="article-title" href="/2020/09/10/pt-sqlbypass/">sql关键词绕过</a></h1></header><div class="article-entry" itemprop="articleBody"><p><a target="_blank" rel="noopener" href="https://blog.lgf.im/2018/bypass-tech-for-sql-injection-keyword-filtering.html">https://blog.lgf.im/2018/bypass-tech-for-sql-injection-keyword-filtering.html</a> 较全的基于关键词绕过</p><p><a target="_blank" rel="noopener" href="https://blog.csdn.net/zpy1998zpy/article/details/80631036">https://blog.csdn.net/zpy1998zpy/article/details/80631036</a> 基于extractvalue()和updatexml()的报错注入</p><link href="//src.wangriyu.wang/lib/Aplayer/APlayer.min.css" rel="stylesheet"><script src="//src.wangriyu.wang/lib/Aplayer/APlayer.min.js"></script><div id="aplayer"></div><script src="/js/player.js"></script></div><div class="article-info article-info-index"><div class="article-count"><div class="article-tag tagcloud"><ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95/" rel="tag">渗透测试</a></li></ul></div><span class="post-count">总字数41</span> <span class="post-count">预计阅读1分钟</span></div><div class="clearfix"></div></div></div></article><article id="post-m01ly-wiki" class="article article-type-post" itemscope itemprop="blogPost"><div class="article-meta"><a href="/2020/09/04/m01ly-wiki/" class="article-date"><time class="published" datetime="2020-09-04T09:54:02.000Z" itemprop="datePublished">2020-09-04 发布</time> <time class="updated" datetime="2021-02-18T08:17:58.920Z" itemprop="dateUpdated">2021-02-18 更新</time></a></div><div class="article-inner"><input type="hidden" class="isFancy"><header class="article-header"><h1 itemprop="name"><a class="article-title" href="/2020/09/04/m01ly-wiki/">个人wiki</a></h1></header><div class="article-entry" itemprop="articleBody"><h1 id="TLS-安全配置"><a href="#TLS-安全配置" class="headerlink" title="TLS 安全配置"></a>TLS 安全配置</h1><h2 id="DHparam"><a href="#DHparam" class="headerlink" title="DHparam"></a>DHparam</h2><p>Diffie-Hellman group smaller than 2048 bits 漏洞</p><p><strong>漏洞描述：</strong></p><ol><li>Diffie-Hellman group smaller than 2048 bits：</li></ol><p>TLS服务器使用Diffie-Hellman组，质数模长度小于2048位。目前的估计是，一个学术团队可以打破768位素数，而一个国家级团队可以打破1024位素数。</p><ol start="2"><li>TLS/SSL Server Is Using Commonly Used Prime Numbers</li></ol><p>在Diffie-Hellman密钥交换期间，服务器使用一个公共素数或默认质数作为参数。这使得安全会话容易受到预计算攻击。攻击者可以花费大量时间为特定质数生成查找/彩虹表。然后，可以使用此查找表获取握手的共享机密并解密会话。</p><p><strong>漏洞分析：</strong></p><p>漏洞1，只需要重新生成2048位DH参数即可。</p><p>漏洞2，因为用了已知的素数，会导致爆破后破解出密钥，因此只需要升级到2048位参数，在2048位DH组下进行这种攻击的可行性被评估为不确定且未经证实。</p><p><strong>漏洞解决方法：</strong>重新生成2048位dhparams。nginx配置如下，其他容器详见<a target="_blank" rel="noopener" href="https://weakdh.org/sysadmin.html">https://weakdh.org/sysadmin.html</a></p><p>1 利用openssl生成2048bit dhparams.pem命令如下：</p><pre class="line-numbers language-bash"><code class="language-bash">openssl dhparam -out dhparams.pem 2048<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>dh协议文件生成速度随长度增长而急剧增长，使用随机数种子可以加快生成速度，如下所示</p><pre class="line-numbers language-bash"><code class="language-bash">openssl dhparam -rand rand.seed -out dhparams.pem 2048<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>2 nginx配置 （nginx.conf文件）：</p><pre class="line-numbers language-bash"><code class="language-bash">ssl_dhparam dhparams.pem的路径<span class="token punctuation">;</span> <span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p><strong>参考：</strong></p><p><a target="_blank" rel="noopener" href="https://weakdh.org/sysadmin.html">https://weakdh.org/sysadmin.html</a> 官方TLS部署Diffie-Hellman指南，包括apache,iis环境下的配置</p><p><a target="_blank" rel="noopener" href="https://gist.github.com/fotock/9cf9afc2fd0f813828992ebc4fdaad6f">https://gist.github.com/fotock/9cf9afc2fd0f813828992ebc4fdaad6f</a> TLS 的nginx安全配置</p><p><a target="_blank" rel="noopener" href="https://kb.fortinet.com/kb/documentLink.do?externalID=FD43985">https://kb.fortinet.com/kb/documentLink.do?externalID=FD43985</a> <a target="_blank" rel="noopener" href="https://www.rapid7.com/db/vulnerabilities/tls-dh-primes">https://www.rapid7.com/db/vulnerabilities/tls-dh-primes</a> 解决方法</p><p><a target="_blank" rel="noopener" href="https://www.openssl.org/docs/man1.1.0/man1/dhparam.html">https://www.openssl.org/docs/man1.1.0/man1/dhparam.html</a> openssl生成 dhparam具体用法</p><p><a target="_blank" rel="noopener" href="https://weakdh.org/logjam.html">https://weakdh.org/logjam.html</a> <a target="_blank" rel="noopener" href="https://weakdh.org/">https://weakdh.org/</a> 相关DH的攻击</p><p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/f-ck-need-u/p/7103791.html">https://www.cnblogs.com/f-ck-need-u/p/7103791.html</a> 加快生成速度</p><link href="//src.wangriyu.wang/lib/Aplayer/APlayer.min.css" rel="stylesheet"><script src="//src.wangriyu.wang/lib/Aplayer/APlayer.min.js"></script><div id="aplayer"></div><script src="/js/player.js"></script></div><div class="article-info article-info-index"><div class="article-count"><div class="article-tag tagcloud"><ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E4%B8%AA%E4%BA%BA%E7%AC%94%E8%AE%B0/" rel="tag">个人笔记</a></li></ul></div><span class="post-count">总字数478</span> <span class="post-count">预计阅读1分钟</span></div><div class="clearfix"></div></div></div></article><article id="post-pt-portinfo" class="article article-type-post" itemscope itemprop="blogPost"><div class="article-meta"><a href="/2020/09/04/pt-portinfo/" class="article-date"><time class="published" datetime="2020-09-04T08:48:44.000Z" itemprop="datePublished">2020-09-04 发布</time> <time class="updated" datetime="2020-09-04T08:57:27.615Z" itemprop="dateUpdated">2020-09-04 更新</time></a></div><div class="article-inner"><input type="hidden" class="isFancy"><header class="article-header"><h1 itemprop="name"><a class="article-title" href="/2020/09/04/pt-portinfo/">常见端口说明和攻击汇总</a></h1></header><div class="article-entry" itemprop="articleBody"><h3 id="文件共享服务端口"><a href="#文件共享服务端口" class="headerlink" title="文件共享服务端口"></a>文件共享服务端口</h3><table><thead><tr><th align="left">端口号</th><th align="left">端口说明</th><th align="left">攻击方向</th></tr></thead><tbody><tr><td align="left">21、22、69</td><td align="left">Ftp/Tftp文件传输协议</td><td align="left">允许匿名的上传、下载、爆破和嗅探</td></tr><tr><td align="left">2049</td><td align="left">Nfs服务</td><td align="left">配置不当</td></tr><tr><td align="left">139</td><td align="left">Samba服务</td><td align="left">爆破、未授权访问、远程代码执行</td></tr><tr><td align="left">389</td><td align="left">Ldap目录访问协议</td><td align="left">注入、允许匿名访问、弱口令</td></tr></tbody></table><h3 id="远程连接服务端口"><a href="#远程连接服务端口" class="headerlink" title="远程连接服务端口"></a>远程连接服务端口</h3><table><thead><tr><th align="left">端口号</th><th align="left">端口说明</th><th align="left">攻击方向</th></tr></thead><tbody><tr><td align="left">22</td><td align="left">SSH远程连接</td><td align="left">爆破、SSH隧道及内网代理转发、文件传输</td></tr><tr><td align="left">23</td><td align="left">Telnet远程连接</td><td align="left">爆破、嗅探、弱口令</td></tr><tr><td align="left">3389</td><td align="left">Rdp远程桌面链接</td><td align="left">Shitf后门（<code>Window Server 2003</code>以下系统）、爆破</td></tr><tr><td align="left">5900</td><td align="left">VNC</td><td align="left">弱口令爆破</td></tr><tr><td align="left">5623</td><td align="left">PyAnywhere服务</td><td align="left">抓密码、代码执行</td></tr></tbody></table><h3 id="Web应用服务端口"><a href="#Web应用服务端口" class="headerlink" title="Web应用服务端口"></a>Web应用服务端口</h3><table><thead><tr><th align="left">端口号</th><th align="left">端口说明</th><th align="left">攻击方向</th></tr></thead><tbody><tr><td align="left">80/443/8080</td><td align="left">常见的Web服务端口</td><td align="left">Web攻击、爆破、对应服务器版本漏洞，心脏滴血等漏洞</td></tr><tr><td align="left">7001/7002</td><td align="left">WebLogic控制台</td><td align="left">Java反序列化、弱口令</td></tr><tr><td align="left">8080/8089</td><td align="left">Jboss/Resin/Jetty/Jenkins</td><td align="left">反序列化、控制器弱口令</td></tr><tr><td align="left">9090</td><td align="left">WebSphere控制台</td><td align="left">Java反序列化、弱口令</td></tr><tr><td align="left">4848</td><td align="left">GlassFish控制台</td><td align="left">弱口令</td></tr><tr><td align="left">1352</td><td align="left">Lotus domino邮件服务</td><td align="left">弱口令、信息泄露、爆破</td></tr><tr><td align="left">10000</td><td align="left">Webmin-Web控制面板</td><td align="left">弱口令</td></tr></tbody></table><h3 id="数据库服务端口"><a href="#数据库服务端口" class="headerlink" title="数据库服务端口"></a>数据库服务端口</h3><table><thead><tr><th align="left">端口号</th><th align="left">端口说明</th><th align="left">攻击方向</th></tr></thead><tbody><tr><td align="left">3306</td><td align="left">Mysqk</td><td align="left">注入、提权、爆破</td></tr><tr><td align="left">1433</td><td align="left">Mysql数据库</td><td align="left">注入、提权、SA弱口令、爆破</td></tr><tr><td align="left">1521</td><td align="left">Oracle数据库</td><td align="left">TNS爆破、注入、反弹Shell</td></tr><tr><td align="left">5432</td><td align="left">PostgreSQL数据库</td><td align="left">爆破、注入、弱口令</td></tr><tr><td align="left">27017/27018</td><td align="left">MongoDB</td><td align="left">爆破、未授权访问</td></tr><tr><td align="left">6379</td><td align="left">Redis数据库</td><td align="left">尝试未授权访问、弱口令爆破</td></tr><tr><td align="left">5000</td><td align="left">SysBase/DB2数据库</td><td align="left">爆破、注入</td></tr></tbody></table><h3 id="邮件服务端口"><a href="#邮件服务端口" class="headerlink" title="邮件服务端口"></a>邮件服务端口</h3><table><thead><tr><th align="left">端口号</th><th align="left">端口说明</th><th align="left">攻击方向</th></tr></thead><tbody><tr><td align="left">25</td><td align="left">SMTP邮件服务</td><td align="left">邮件伪造</td></tr><tr><td align="left">110</td><td align="left">POP3协议</td><td align="left">爆破、嗅探</td></tr><tr><td align="left">143</td><td align="left">IMAP协议</td><td align="left">爆破</td></tr></tbody></table><h3 id="网络参加协议端口"><a href="#网络参加协议端口" class="headerlink" title="网络参加协议端口"></a>网络参加协议端口</h3><table><thead><tr><th align="left">端口号</th><th align="left">端口说明</th><th align="left">攻击方向</th></tr></thead><tbody><tr><td align="left">53</td><td align="left">DNS域名服务器</td><td align="left">允许区域传送、DNS劫持、缓存投毒、欺骗</td></tr><tr><td align="left">67/68</td><td align="left">DHCP服务</td><td align="left">劫持、欺骗</td></tr><tr><td align="left">161</td><td align="left">SNMP协议</td><td align="left">爆破、搜索目标内网信息</td></tr></tbody></table><h3 id="特殊服务端口"><a href="#特殊服务端口" class="headerlink" title="特殊服务端口"></a>特殊服务端口</h3><table><thead><tr><th align="left">端口号</th><th align="left">端口说明</th><th align="left">攻击方向</th></tr></thead><tbody><tr><td align="left">2181</td><td align="left">Zookeeper服务</td><td align="left">未授权访问</td></tr><tr><td align="left">8069</td><td align="left">Zavvux服务</td><td align="left">远程代码执行、SQL注入</td></tr><tr><td align="left">9200</td><td align="left">9300</td><td align="left">Elasticsearch服务</td></tr><tr><td align="left">11211</td><td align="left">Memcache服务</td><td align="left">未授权访问</td></tr><tr><td align="left">512/513/514</td><td align="left">Linux Rexec服务</td><td align="left">匿名访问、文件上传</td></tr><tr><td align="left">3690</td><td align="left">Svn服务</td><td align="left">Svn泄露、未授权访问</td></tr><tr><td align="left">50000</td><td align="left">SAP Management Console</td><td align="left">远程代码执行</td></tr></tbody></table><link href="//src.wangriyu.wang/lib/Aplayer/APlayer.min.css" rel="stylesheet"><script src="//src.wangriyu.wang/lib/Aplayer/APlayer.min.js"></script><div id="aplayer"></div><script src="/js/player.js"></script></div><div class="article-info article-info-index"><div class="article-count"><div class="article-tag tagcloud"><ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95/" rel="tag">渗透测试</a></li></ul></div><span class="post-count">总字数605</span> <span class="post-count">预计阅读2分钟</span></div><div class="clearfix"></div></div></div></article><article id="post-htps-attack-heartbleed" class="article article-type-post" itemscope itemprop="blogPost"><div class="article-meta"><a href="/2020/09/03/htps-attack-heartbleed/" class="article-date"><time class="published" datetime="2020-09-03T02:10:29.000Z" itemprop="datePublished">2020-09-03 发布</time> <time class="updated" datetime="2020-09-03T13:12:34.808Z" itemprop="dateUpdated">2020-09-03 更新</time></a></div><div class="article-inner"><input type="hidden" class="isFancy"><header class="article-header"><h1 itemprop="name"><a class="article-title" href="/2020/09/03/htps-attack-heartbleed/">TLS攻击之心脏滴血</a></h1></header><div class="article-entry" itemprop="articleBody"><h1 id="一-心脏滴血介绍"><a href="#一-心脏滴血介绍" class="headerlink" title="一 心脏滴血介绍"></a>一 心脏滴血介绍</h1><p><strong>心脏滴血漏洞(CVE-2014-0160)</strong> 是一个出现在加密程序库OpenSSL的安全漏洞，openssl是用于实现TLS协议的库。</p><p><strong>受影响的版本：</strong> OpenSSL1.0.1、1.0.1a 、1.0.1b 、1.0.1c 、1.0.1d 、1.0.1e、1.0.1f、Beta 1 of OpenSSL 1.0.2等版本</p><p><strong>影响范围</strong>：只要使用的是存在缺陷的OpenSSL实例，无论是服务器还是客户端，都可能因此而受到攻击。 因为缺陷在于OpenSSL的实现，而不是SSL/TLS协议本身，所以除了OpenSSL之外的其他TLS实现方式，如GnuTLS、Mozilla的网络安全服务（NSS）和Windows平台的TLS实现都不受影响。</p><p><strong>漏洞原理：</strong>在实现TLS的心跳扩展时没有对输入进行适当验证（缺少边界检查，因此漏洞的名称来源于“心跳”（heartbeat）。该程序错误属于缓冲区过读，即可以读取的数据比应该允许读取的还多 。</p><h1 id="二-漏洞原理分析"><a href="#二-漏洞原理分析" class="headerlink" title="二 漏洞原理分析"></a>二 漏洞原理分析</h1><h2 id="2-1-心跳机制"><a href="#2-1-心跳机制" class="headerlink" title="2.1 心跳机制"></a>2.1 心跳机制</h2><p>TLS / SSL协议的一个重要组成部分被称为“心跳”。从本质上讲，<strong>心跳就是两台电脑互相通信从而让对方知道它们仍然相连，即使用户没有下载或上传任何东西。</strong></p><p><strong>（1） 正常心跳检测</strong></p><p>每过一段时间，浏览器会发送一个加密的数据到服务器端，这被称为心跳请求，至关重要的是，心跳请求里包含自己的长度信息。例如下图中，</p><p><strong>客户端：</strong>内容为abcdefghij,，自己的长度为10字节 。</p><p><strong>服务器</strong>：收到消息时，会分配一个内存缓冲区（一个物理内存区域用以存储信息），该区域的存储空间和心跳请求信号里的长度一致，即10字节。接下来，它会存储请求信号的加密数据到内存缓冲区，然后读取数据并将其发送回你的浏览器，来证明连接仍然存在。</p><p><img src="/2020/09/03/htps-attack-heartbleed/1599116465905.png" alt="1599116465905"></p><p><strong>（2） 心脏滴血</strong></p><p>心脏出血漏洞的出现是因为，**OpenSSL的心跳功能缺少了一个至关重要的安全维护手段：计算机接受心跳请求时从不检查该请求和它声称的内容是否一致，及从不检查所请求的数据长度是否和声称的数据长度一致，导致响应方返回额外长度的数据，具体如下图所示：</p><p><strong>客户端心跳请求：</strong>abcdefghij,，心跳长度为10字节 。</p><p><strong>服务器端：</strong>接收心跳数据后，没有对心跳请求数据长度和声称 的10字节长度进行检查，直接分配200字节缓存区，存储心跳数据。返回数据时，从缓冲区读取200字节的数据返回给客户端。这时候缓冲区可能会存在密钥，用户名，密码等隐私信息（可想而知payload需要精心构造以读取有用的隐私信息，这里仅仅简单描述攻击原理）。</p><p><img src="/2020/09/03/htps-attack-heartbleed/1599117066503.png" alt="1599117066503"></p><h2 id="2-2-心脏出血错误代码"><a href="#2-2-心脏出血错误代码" class="headerlink" title="2.2 心脏出血错误代码"></a>2.2 心脏出血错误代码</h2><p>导致心脏出血漏洞的编程错误可以归于一行代码：</p><pre><code>memcpy(bp, pl, payload);</code></pre><p>memcpy()是复制数据的命令。bp是被复制的数据的存储区域，pl是被复制的数据的来源，payload是被复制的数据长度。<strong>问题在于，该命令没有检验pl复制的数据是否和payload给予的长度相符。</strong></p><h1 id="3-修复心脏滴血漏洞"><a href="#3-修复心脏滴血漏洞" class="headerlink" title="3 修复心脏滴血漏洞"></a>3 修复心脏滴血漏洞</h1><p>修补心脏出血漏洞的方式是更新最新的OpenSSL版本，你可以在官网上获取相关链接 <a target="_blank" rel="noopener" href="https://www.openssl.org/source/">https://www.openssl.org/source/</a> 。</p><p>因为OpenSSL是开源的，以下是<strong>修复过的代码</strong>： 代码的第一部分的功能是确定心跳请求的大小不是0KB，不然可能会出错。第二部分用来检验心跳的长度是否和它声称的相符。</p><pre class="line-numbers language-python"><code class="language-python"><span class="token operator">*</span> Read type <span class="token operator">and</span> payload length first<span class="token operator">*</span><span class="token operator">/</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">+</span> <span class="token number">2</span> <span class="token operator">+</span> <span class="token number">16</span> <span class="token operator">></span> s<span class="token operator">-</span><span class="token operator">></span>s3<span class="token operator">-</span><span class="token operator">></span>relent<span class="token punctuation">)</span>
<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token operator">/</span>silently discard <span class="token operator">*</span><span class="token operator">/</span>
hbtype <span class="token operator">=</span> <span class="token operator">*</span>p<span class="token operator">+</span><span class="token operator">+</span><span class="token punctuation">;</span>
n2s<span class="token punctuation">(</span>p<span class="token punctuation">,</span> payload<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">+</span> <span class="token number">2</span> <span class="token operator">+</span> payload <span class="token operator">+</span> <span class="token number">16</span> <span class="token operator">></span> s<span class="token operator">-</span><span class="token operator">></span>s3<span class="token operator">-</span><span class="token operator">></span>rrec<span class="token punctuation">.</span>length<span class="token punctuation">)</span>
<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token operator">/</span> silently discard per RFC <span class="token number">6520</span> sec<span class="token punctuation">.</span> <span class="token number">4</span> <span class="token operator">*</span><span class="token operator">/</span>
pl <span class="token operator">=</span> p<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h1 id="4-心脏滴血漏洞检测"><a href="#4-心脏滴血漏洞检测" class="headerlink" title="4  心脏滴血漏洞检测"></a>4 心脏滴血漏洞检测</h1><h2 id="4-1-nmap"><a href="#4-1-nmap" class="headerlink" title="4.1  nmap"></a>4.1 nmap</h2><pre class="line-numbers language-bash"><code class="language-bash">nmap -p 443 --script ssl-heartbleed 66.175.219.225
或者
nmap -sV --script<span class="token operator">=</span>ssl-heartbleed 111.X.X.53 -p 443<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>其他检测TLS工具也可检测，具体见：<a href="https://m01ly.github.io/2020/08/26/htps-tools/">TLS检测小工具</a></p><h2 id="4-2-网上在线检测"><a href="#4-2-网上在线检测" class="headerlink" title="4.2 网上在线检测"></a>4.2 网上在线检测</h2><p><a target="_blank" rel="noopener" href="http://possible.lv/tools/hb/">http://possible.lv/tools/hb/</a></p><p><a target="_blank" rel="noopener" href="http://filippo.io/Heartbleed/">http://filippo.io/Heartbleed/</a></p><h1 id="参考："><a href="#参考：" class="headerlink" title="参考："></a>参考：</h1><p>1 <a target="_blank" rel="noopener" href="https://www.aqniu.com/news-views/28453.html">https://www.aqniu.com/news-views/28453.html</a> 通俗易懂</p><p>2 <a target="_blank" rel="noopener" href="https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2014-0160">https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2014-0160</a> 漏洞详情</p><p>3 <a target="_blank" rel="noopener" href="https://blog.csdn.net/yaofeiNO1/article/details/54428021">https://blog.csdn.net/yaofeiNO1/article/details/54428021</a> 可利用的payload</p><p>4 <a target="_blank" rel="noopener" href="https://www.cnblogs.com/KevinGeorge/p/8029947.html">https://www.cnblogs.com/KevinGeorge/p/8029947.html</a> POC</p><p>5<a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/%E5%BF%83%E8%84%8F%E5%87%BA%E8%A1%80%E6%BC%8F%E6%B4%9E">https://zh.wikipedia.org/wiki/%E5%BF%83%E8%84%8F%E5%87%BA%E8%A1%80%E6%BC%8F%E6%B4%9E</a> wiki</p><link href="//src.wangriyu.wang/lib/Aplayer/APlayer.min.css" rel="stylesheet"><script src="//src.wangriyu.wang/lib/Aplayer/APlayer.min.js"></script><div id="aplayer"></div><script src="/js/player.js"></script></div><div class="article-info article-info-index"><div class="article-count"><div class="article-tag tagcloud"><ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/TLS/" rel="tag">TLS</a></li></ul></div><span class="post-count">总字数1.2k</span> <span class="post-count">预计阅读4分钟</span></div><div class="clearfix"></div></div></div></article><article id="post-htps-attack-paddingoracle" class="article article-type-post" itemscope itemprop="blogPost"><div class="article-meta"><a href="/2020/09/01/htps-attack-paddingoracle/" class="article-date"><time class="published" datetime="2020-09-01T03:20:23.000Z" itemprop="datePublished">2020-09-01 发布</time> <time class="updated" datetime="2020-09-03T13:12:42.374Z" itemprop="dateUpdated">2020-09-03 更新</time></a></div><div class="article-inner"><input type="hidden" class="isFancy"><header class="article-header"><h1 itemprop="name"><a class="article-title" href="/2020/09/01/htps-attack-paddingoracle/">TLS 攻击之POODLE</a></h1></header><div class="article-entry" itemprop="articleBody"><p>转载 <a target="_blank" rel="noopener" href="http://www.bewindoweb.com/272.html%EF%BC%8C%E5%85%B7%E4%BD%93%E5%AE%9E%E4%BE%8B%E5%88%86%E6%9E%90%EF%BC%8C%E5%86%99%E7%9A%84%E5%BE%88%E5%A5%BD%EF%BC%8C%E7%84%B6%E5%90%8E%E6%96%87%E7%AB%A0%E6%88%91%E5%8A%A0%E5%85%A5%E4%BA%86%E8%87%AA%E5%B7%B1%E7%9A%84%E7%90%86%E8%A7%A3%E3%80%82">http://www.bewindoweb.com/272.html，具体实例分析，写的很好，然后文章我加入了自己的理解。</a></p><h2 id="一、-POODLE简介"><a href="#一、-POODLE简介" class="headerlink" title="一、 POODLE简介"></a>一、 POODLE简介</h2><p>2014年9月Google的一份研究报告<a target="_blank" rel="noopener" href="https://www.openssl.org/~bodo/ssl-poodle.pdf">《This POODLE Bites: Exploiting The SSL 3.0 Fallback》</a>指出，SSL存在安全漏洞CVE­-2014-3566，代号为POODLE（Padding Oracle On Downgraded Legacy Encryption，基于降级旧加密协议的填充提示），该漏洞可以使得攻击者获取到一段明文数据，比如HTTP的cookie。</p><p><strong>漏洞影响版本：</strong>SSL v3.0以下</p><p><strong>防御方法：</strong>完全禁用SSL，或者利用TLS_FALLBACK_SCSV字段禁止协议降级到SSL</p><h1 id="二、Padding-Oracle-攻击原理"><a href="#二、Padding-Oracle-攻击原理" class="headerlink" title="二、Padding Oracle 攻击原理"></a>二、Padding Oracle 攻击原理</h1><p>Padding Oracle是Web程序渗透的经典攻击方式，由Juliano Rizzo和Thai Duong于2010年<a target="_blank" rel="noopener" href="http://netifera.com/research/">《Practical Padding Oracle Attacks》</a>提出，该攻击利用CBC（Cipher-block chaining，密码块链接模式）加密模式中的填充漏洞给出的提示信息逐步推导出明文数据。</p><h2 id="2-1-CBC密码块链接模式——加密"><a href="#2-1-CBC密码块链接模式——加密" class="headerlink" title="2.1 CBC密码块链接模式——加密"></a><strong>2.1 CBC密码块链接模式——加密</strong></h2><p><img src="/2020/09/01/htps-attack-paddingoracle/1598950607286.png" alt="1598950607286"></p><p>（1）对明文进行分组，每组长度相同（一般为8字节或16字节），对长度不足的分组需要进行填充（Padding）。</p><p>填充通常遵循的是PKCS5标准，即填充的字符是需要填充字符的个数。</p><p>例如，这里的明文字符串为“GET /a HTTP/1.1\r”，那么按ASCII的十六进制就可以表示为：</p><ul><li>第一组明文：“0x47、0x45、0x54、0x20、0x2F、0x61、0x20、0x48”</li><li>第二组明文：“0x54、0x54、0x50、0x2F、0x31、0x2E、0x31、0x0D”</li></ul><p>假设后面还有字符不能构成8字节的一组，那么需要进行填充，例如（前面字符没有用十六进制表示）：</p><p><img src="/2020/09/01/htps-attack-paddingoracle/1598950619500.png" alt="1598950619500"></p><p>当然，一般不会有全填充的组。</p><p>（2）随机生成一个初始化向量IV，与第一个明文分组进行异或运算得到中间值（Intermediary Value）。</p><p>例如这里随机生成的IV为“0x01、0x02、0x03、0x04、0x05、0x06、0x07、0x08”，与第一个分组“0x47、0x45、0x54、0x20、0x2F、0x61、0x20、0x48”进行异或后得到“0x46、0x47、0x57、0x24、0x2A、0x67、0x27、0x40”。</p><p>（3）将异或结果进行加密，得到第一个明文分组的密文。</p><p>一般会使用密钥（key）加密，这里简单假设密钥加密效果等同于加密函数y = f(x) = x + 1，那么可以得到第一组密文“0x47、0x48、0x58、0x25、0x2B、0x68、0x28、0x41”。</p><p>（4）从第二个明文分组开始，将上一组密文当作IV，进行异或运算，再进行加密，得到该组密文。</p><p>例如这里由第一组密文“0x47、0x48、0x58、0x25、0x2B、0x68、0x28、0x41”与第二组明文“0x54、0x54、0x50、0x2F、0x31、0x2E、0x31、0x0D”进行异或，得到“0x13、0x1C、0x08、0x0A、0x1A、0x46、0x19、0x4C”，再进行相同加密，得到“0x14、0x1D、0x09、0x0B、0x1B、0x47、0x1A、0x4D”，这就是第二组密文。</p><h2 id="2-2-CBC密码块链接模式——解密"><a href="#2-2-CBC密码块链接模式——解密" class="headerlink" title="2.2 CBC密码块链接模式——解密"></a><strong>2.2 CBC密码块链接模式——解密</strong></h2><p><img src="/2020/09/01/htps-attack-paddingoracle/1598950639436.png" alt="1598950639436"></p><p>加密的IV是随机生成的，而解密则必须使用这个IV。</p><p>（1）对密文进行分组，每组长度相同（一般为8字节或16字节）。</p><p>例如这里将密文分为了两组：</p><ul><li>第一组密文：“0x47、0x48、0x58、0x25、0x2B、0x68、0x28、0x41”</li><li>第二组密文：“0x14、0x1D、0x09、0x0B、0x1B、0x47、0x1A、0x4D”</li></ul><p>（2）对密文进行解密，得到中间值。</p><p>一般使用密钥，同样的这里假设密钥效果等同于函数x = f(y) = y - 1</p><ul><li>第一组中间值：“0x46、0x47、0x57、0x24、0x2A、0x67、0x27、0x40”</li><li>第二组中间值：“0x13、0x1C、0x08、0x0A、0x1A、0x46、0x19、0x4C”</li></ul><p>（3）使用初始化向量IV，与第一个分组进行异或运算得到第一组明文。</p><p>这是利用异或的性质：a⊕b=c，a⊕c=b，b⊕c=a，所以无论如何异或都能得到唯一的第三个数。</p><p>例如这里IV为“0x01、0x02、0x03、0x04、0x05、0x06、0x07、0x08”，第一个数0x01与第一组第一个中间值0x46异或结果为0x47，就是明文“G”的ASCII十六进制表示，于是得到第一组明文“0x47、0x45、0x54、0x20、0x2F、0x61、0x20、0x48”</p><p>（4）从第二组开始，依次将前一组密文和该组中间值异或，得到该组明文。</p><p>例如第一组密文“0x47、0x48、0x58、0x25、0x2B、0x68、0x28、0x41”和第二组中间值“0x13、0x1C、0x08、0x0A、0x1A、0x46、0x19、0x4C”异或得到第二组明文“0x54、0x54、0x50、0x2F、0x31、0x2E、0x31、0x0D”。</p><p>值得注意的是，<strong>解密可以并行计算，因为密文都是已经获取好的</strong>；加密则不行，因为前一组密文必须要计算出来。</p><h2 id="2-3-Padding-Oracle-攻击"><a href="#2-3-Padding-Oracle-攻击" class="headerlink" title="2.3 Padding Oracle 攻击"></a><strong>2.3 Padding Oracle 攻击</strong></h2><h4 id="2-3-1-攻击原理"><a href="#2-3-1-攻击原理" class="headerlink" title="2.3.1 攻击原理"></a>2.3.1 攻击原理</h4><p><img src="/2020/09/01/htps-attack-paddingoracle/1599017277323.png" alt="1599017277323"></p><p><strong>攻击最终原理：</strong></p><p><strong>目标：</strong>已知IV，密文。求中间值。</p><p><strong>方法：</strong></p><p>通过逐字节伪造IV使得：<br>$$<br>伪造IV+中间值=0x01(明文)<br>$$<br>（因为服务器端会进行padding校验，回显成功与否，这里用的padding是pkcs#5）</p><p>然后利用：<br>$$<br>0x01(明文)+真实IV=中间值<br>$$<br>即可求得中间值，从而通过下列等式求得明文。<br>$$<br>真实IV+中间值=明文<br>$$</p><h4 id="2-3-2-攻击过程"><a href="#2-3-2-攻击过程" class="headerlink" title="2.3.2 攻击过程"></a>2.3.2 攻击过程</h4><hr><p>首先请注意，始终在字符串的末尾附加至少一个填充字节，因此将使用0x01填充7字节的值（如AVOCADO），而将8字节的值（如PLANTAIN）具有向其中添加了完整的填充块。填充字节的值还指示字节数，因此逻辑上最后一个密文块末尾的逻辑最终值必须是：</p><ul><li>单个0x01字节（0x01）</li><li>两个0x02字节（0x02、0x02）</li><li>三个0x03字节（0x03、0x03、0x03）</li><li>四个0x04字节（0x04、0x04、0x04、0x04）</li><li>…等等</li></ul><p><strong>如果最终的解密块未以这些有效字节序列之一结尾，则大多数密码提供程序将抛出无效的填充异常。引发此异常的事实对于攻击者（我们）而言至关重要，因为它是填充预言攻击的基础</strong>。</p><p>现在构造一个场景：假设密文仍然是上述字段“GET /a HTTP/1.1\r”，且用户连接到的是公共WIFI，攻击者可以通过抓包获取CBC密文以及初始化向量IV（当然要把IV明文传给服务器否则服务器无法解密第一个分组）。</p><p>我们现在希望通过密文和IV获取明文，由于“IV⊕中间值=明文”，问题转变为如何求IV对应的中间值。</p><p>我们知道，对大多数Web服务器而言：</p><ul><li><p>收到有效的密文（正确填充并包含有效数据的密文）后，应用程序将正常响应（200 OK）</p></li><li><p>收到无效的密文（解密后不会以有效填充结尾）时，应用程序将引发加密异常（500 Internal Server Error）</p></li><li><p><em>收到有效的密文（正确填充的密文）但解密为无效值时，应用程序将显示自定义错误消息（200 OK）</em></p><p>上面描述的场景是经典的Padding Oracle，因为我们可以使用应用程序的行为轻松确定提供的加密值是否正确填充。术语oracle是指可以用来确定测试通过还是失败的机制。</p><p>IV出现在解密的最后一步，而且是可以构造的，那么攻击者可以通过构造特殊的IV，直到符合“填充”规则通过解密流程（虽然不一定能通过数据合法性校验），具体而言：</p></li></ul><p>（1）构造“0x00、0x00、0x00、0x00、0x00、0x00、0x00、0x00”的特殊IV发送给服务端，不断尝试递增最后一位并发送给服务端，直到服务端解密成功。</p><p><img src="/2020/09/01/htps-attack-paddingoracle/1598950652145.png" alt="1598950652145"></p><p>此时必然产生了1位填充（因为我们已经知道IV是0x01、0x02、0x03、0x04、0x05、0x06、0x07、0x08），最多尝试次数为256次。（<strong>这里最后一位必须为01才可以通过服务器的padding校验，因为采用的是PKCS5标准填充</strong>）</p><p>（2）计算出末位中间值，其值等于伪造向量末位异或0x01：0x41⊕0x01=0x40</p><p><img src="/2020/09/01/htps-attack-paddingoracle/1598950673196.png" alt="1598950673196"></p><p>（3）利用原始向量末位值异或中间值，得到明文0x48，即字符“H”：0x40⊕0x08=0x48</p><p><img src="/2020/09/01/htps-attack-paddingoracle/1598950689577.png" alt="1598950689577"></p><p>（4）利用中间值计算出末位为0x02的伪造向量应有值：0x40⊕0x02=0x42</p><p><img src="/2020/09/01/htps-attack-paddingoracle/1598950705091.png" alt="1598950705091"></p><p>（5）通过改变倒数第二位，直到生成0x020x02的末位明文填充字符，符合2位填充规则，然后类似地推测倒数第二位的中间值：</p><p><img src="http://cdn.bewindoweb.com/uploadpic/9a93974acc1def3a2247974deb3a6392.jpeg" alt="img"></p><p>重复上述步骤，就能够得到完整的明文信息，这就是Padding Oracle 填充提示攻击。</p><h1 id="三、POODLE攻击原理"><a href="#三、POODLE攻击原理" class="headerlink" title="三、POODLE攻击原理"></a>三、POODLE攻击原理</h1><h2 id="3-1-SSLv3-0存在的问题"><a href="#3-1-SSLv3-0存在的问题" class="headerlink" title="3.1 SSLv3.0存在的问题"></a><strong>3.1 SSLv3.0存在的问题</strong></h2><p>SSLv3.0的记录层可以使用如下加密方式：</p><table><thead><tr><th align="left">加密类型</th><th align="left">加密方式</th></tr></thead><tbody><tr><td align="left">块加密 Block Cipher</td><td align="left">IDEA</td></tr><tr><td align="left">块加密 Block Cipher</td><td align="left">RC2-40</td></tr><tr><td align="left">块加密 Block Cipher</td><td align="left">DES-40</td></tr><tr><td align="left">块加密 Block Cipher</td><td align="left">DES</td></tr><tr><td align="left">块加密 Block Cipher</td><td align="left">3DES</td></tr><tr><td align="left">块加密 Block Cipher</td><td align="left">FORTEZZA</td></tr><tr><td align="left">流加密 Stream Cipher</td><td align="left">RC-40</td></tr><tr><td align="left">流加密 Stream Cipher</td><td align="left">RC4-128</td></tr></tbody></table><p>流加密这里不讨论，也是有安全问题，主要讨论CBC块加密。</p><p><img src="/2020/09/01/htps-attack-paddingoracle/1598952050289.png" alt="1598952050289"></p><p>SSL记录层加密的是原始数据+MAC（消息验证码）信息摘要+填充字节，MAC一般是Hash值，SSLv3.0中MAC通常为20字节。也就是说，SSL先对数据做完整性校验，再进行CBC加密。在CBC解密的一端（服务器），SSL没有规定padding填充块字节内容，只校验填充块最后一个字节，该字节为填充长度，然后去掉填充的字符，再进行MAC验证，最后获得明文数据。</p><ul><li>先校验完整性，再加密，使得对端收到数据后先解密，后校验完整性，解密是否成功为攻击提供了判断依据；</li><li>只验证填充块的最后一个字节，因此填充块可以填充任意字符，且最后字符固定使得攻击者可以利用类似Padding Oracle的攻击机制。</li></ul><p>我们可以利用类似前面Padding Oracle的思路，将要解密的字符放到最后一个块末尾，不断地调整前一个IV的值（可能是初始化向量，也可能是前一段的密文，并且无论是哪个攻击者都是知道的），直到成功通过解密，此时明文必定为0x07或0x15（16字节一块的话）（因为需要填充一整块），最多尝试256次（或512次），就能够通过服务器验证，从而推导出对应的中间值，然后利用该中间值和IV推导出明文。这期间不用担心修改IV导致MAC校验失败，因为那是CBC解密之后的事情。</p><h2 id="3-2-利用SSL漏洞进行POODLE攻击"><a href="#3-2-利用SSL漏洞进行POODLE攻击" class="headerlink" title="3.2 利用SSL漏洞进行POODLE攻击"></a><strong>3.2 利用SSL漏洞进行POODLE攻击</strong></h2><p>假设攻击者B代理了客户端A的HTTPS访问服务器C的请求，可以截获到SSL密文数据以及SSL握手阶段的IV，且可以通过A去发送HTTPS请求，此时如果A没有退出登录，都会自动携带上Cookie。这样，B可以控制A发送的HTTP请求中的请求路径Path和请求体Body，并通过调整Path和Body，让A发出的请求满足两个条件：</p><ul><li>填充字段恰好填充了一个块长度</li><li>Cookie的第一个未知字符刚好出现在前面某个块的末尾</li></ul><p>例如，加密采用3DES，8字节一个块，且SSL上层为HTTP协议，发送的明文为：</p><pre class="line-numbers language-html"><code class="language-html">GET / HTTP/1.1\r\nCookie: abcdefgh \r\n\r\nXXXX MAC数据 XXXXXX7<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p><img src="http://cdn.bewindoweb.com/uploadpic/4343d6e74ca6d402f60be08d3af7e425.jpeg" alt="img"></p><p>MAC数据可能并不是刚好8字节，不过无所谓。攻击者并不知道明文，但知道Cookie密文的位置，知道此时想要解密的cookie的最后一个字符在第4个块末尾。然后攻击者将整个块的密文复制到最后一个填充块密文上：</p><p><img src="http://cdn.bewindoweb.com/uploadpic/865b1480ac514fd22f27de5b08825418.jpeg" alt="img"></p><p>然后不断调整前一块（MAC数据）对应密文位置的值，直到通过解密校验，根据SSL的漏洞，此时最后一块最后一个值必然为0x07：</p><p><img src="http://cdn.bewindoweb.com/uploadpic/be0160296022f639c6aa6c25b3917167.jpeg" alt="img"></p><p>这里例子举得不好，0x07密文也是0x07，后面用0x07明、0x07密来区分，此时我们假设未知加密函数为f(x)，其逆为g(y)，那么根据CBC解密流程，有：</p><pre class="line-numbers language-c"><code class="language-c"><span class="token number">0x07</span>明 <span class="token operator">=</span> <span class="token function">g</span><span class="token punctuation">(</span><span class="token number">0x07</span>密<span class="token punctuation">)</span> ⊕  <span class="token number">0x01</span>  <span class="token operator">=</span><span class="token operator">></span> <span class="token function">g</span><span class="token punctuation">(</span><span class="token number">0x07</span>密<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">0x06</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>现在要求：（此时要注意不是拿0x6E ⊕ g(0x07密）,因为如果解密第四块，应该是第三块 最后一字符⊕g(0x07密））</p><pre class="line-numbers language-c"><code class="language-c">x <span class="token operator">=</span> <span class="token number">0x6E</span> ⊕ <span class="token function">g</span><span class="token punctuation">(</span><span class="token number">0x07</span>密）<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>因此x = 0x68，即字符”h”，得到解密明文”h”。</p><p>同理，通过控制请求路径，例如GET /a、GET /aa，不断地把已经解密的Cookie字符挤出，把未知字符留在该块末尾，然后循环进行前述操作，即可得到完整的Cookie字段。</p><h2 id="3-3-Padding验证和MAC验证返回结果不同的情况"><a href="#3-3-Padding验证和MAC验证返回结果不同的情况" class="headerlink" title="3.3 Padding验证和MAC验证返回结果不同的情况"></a><strong>3.3 Padding验证和MAC验证返回结果不同的情况</strong></h2><p>前面的操作都是建立在Padding验证和MAC验证返回结果不同的基础之上，如果返回结果相同，那么MAC会校验不过导致失去判断Padding验证成功的依据。此时攻击者需要利用响应时间的差异来进行判断。如果响应时间仍然相同，那么这种攻击就无效了。</p><h2 id="3-4-POODLE中“降级”的体现"><a href="#3-4-POODLE中“降级”的体现" class="headerlink" title="3**.4 POODLE中“降级”的体现**"></a>3**.4 POODLE中“降级”的体现**</h2><p>POODLE只在SSLv3.0以下版本才容易攻击成功，TLS会检查填充字符，所以TLS构造的padding通过服务器验证概率极低，TLSv1.3以后则完全避免了该漏洞。2014年，TLS已经得到广泛应用，但不乏少数服务器、客户端（比如IE6）和中间网络设备仍然采用SSL协议。因此为了平滑过渡增加用户体验，TLS1.2、TLS1.1、TLS1.0协议实现都会向后兼容SSLv3.0协议，最终协商通信协议为服务端和客户端支持的最高版本协议。如果记录协议中采用的是RC4流加密或者CBC模式的块加密，那么攻击者就可以进行POODLE攻击。</p><h1 id="4-解决方法"><a href="#4-解决方法" class="headerlink" title="4 解决方法"></a>4 解决方法</h1><p>禁用SSL 3.0协议(ssl version ssl3.0 disable)。</p><h2 id="4-1-服务端禁用方法"><a href="#4-1-服务端禁用方法" class="headerlink" title="4.1 服务端禁用方法"></a>4.1 服务端禁用方法</h2><p><strong>（1）Apache 2.x:</strong><br>在mod_ssl配置文件中使用如下命令禁用SSLv2和SSLv3：<br>SSLProtocol All -SSLv2 -SSLv3<br>重启Apache</p><p><strong>（2）Nginx:</strong><br>在配置文件中使用：<br>ssl_protocols TLSv1 TLSv1.1 TLSv1.2;<br>重启Nginx</p><p><strong>（3）lighttpd：</strong><br>确认lighttpd为1.4.29及以上版本<br>在配置文件中使用<br>ssl.use-sslv3 = “disable”<br>重启lighttpd</p><p><strong>（4）tomcat参考:</strong></p><pre><code>https://tomcat.apache.org/tomcat-6.0-doc/ssl-howto.html</code></pre><p><a target="_blank" rel="noopener" href="https://tomcat.apache.org/tomcat-7.0-doc/ssl-howto.html">https://tomcat.apache.org/tomcat-7.0-doc/ssl-howto.html</a></p><p><strong>（5）IIS:</strong><br>查找如下注册表项：<br>HKey_Local_MachineSystemCurrentControlSetControlSecurityProviders SCHANNELProtocols<br>该注册表项通常包含以下子项：</p><ul><li>PCT 1.0</li><li>SSL 2.0</li><li>SSL 3.0</li><li>TLS 1.0<br>每个注册表项都保留适用于该项的协议相关信息。可以在服务器上禁用这些协议中的任一种。为此，</li></ul><p>请在协议SSL 3.0的服务器子项中创建一个新的DWORD值。名称为Enabled,将DWORD值设置为“00 00 00 00”。 重启IIS服务</p><h2 id="4-2-浏览器禁用方法"><a href="#4-2-浏览器禁用方法" class="headerlink" title="4.2 浏览器禁用方法"></a>4.2 浏览器禁用方法</h2><p><strong>（1）IE:</strong><br>“工具” -&gt; “Internet 选项” -&gt; “高级” ，取消”使用 SSL 3.0”的复选框。<br><strong>（2）Chrome:</strong></p><p>复制一个平时打开 Chrome 浏览器的快捷方式，在新的快捷方式上右键点击，进入属性，<br>在”目标”后面的空格中字段的末尾输入以下命令 –ssl-version-min=tls1<br><strong>（3）FireFox:</strong></p><p>在地址栏输入”about:config”，然后将 security.tls.version.min 调至 1。</p><h1 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h1><p>1、<a target="_blank" rel="noopener" href="https://www.jianshu.com/p/ad8bdd87e131">《Web狗要懂的Padding Oracle攻击》</a>：很详细</p><p>2、<a target="_blank" rel="noopener" href="https://www.jianshu.com/p/1851f778e579">《Padding Oracle》</a></p><p>3、[《百度百科：Padding Oracle》](<a target="_blank" rel="noopener" href="https://baike.baidu.com/item/Padding">https://baike.baidu.com/item/Padding</a> Oracle/3530091?fr=aladdin)</p><p>4、<a target="_blank" rel="noopener" href="https://baike.baidu.com/item/ASCII/309296?fr=aladdin">《ASCII表》</a>和<a target="_blank" rel="noopener" href="https://www.23bei.com/tool-531.html">在线异或计算器</a>：便于实验</p><p>5、<a target="_blank" rel="noopener" href="https://www.cnblogs.com/xzjf/p/8251651.html">《HTTPS 协议降级攻击原理》</a>：对攻击原理理解透彻</p><p>6、<a target="_blank" rel="noopener" href="http://www.vuln.cn/6135">《CVE-2014-3566 SSLv3 POODLE原理分析 – insight-labs》</a>：有些许理解错误，注意辨别</p><p>7、<a target="_blank" rel="noopener" href="https://www.imperialviolet.org/2014/10/14/poodle.html">《POODLE attacks on SSLv3 (14 Oct 2014)》</a>：英文原文例子</p><p>8、<a target="_blank" rel="noopener" href="https://blog.csdn.net/howeverpf/article/details/40350113">《漏洞分析—SSLv3降级加密协议Padding Oracle攻击（POODLE）技术分析》</a>：例子详细</p><p>9、<a target="_blank" rel="noopener" href="http://www.bubuko.com/infodetail-413104.html">《SSLv3 POODLE 攻击分析》</a>：最正确的一篇分析</p><p>10、<a target="_blank" rel="noopener" href="https://www.openssl.org/~bodo/ssl-poodle.pdf">《This POODLE Bites: Exploiting The SSL 3.0 Fallback》</a>：Google研究报告原文</p><p>11 <a target="_blank" rel="noopener" href="https://www.onebug.org/%E7%BB%BF%E7%9B%9F%E6%BC%8F%E6%B4%9E%E5%BA%93/87280.html">https://www.onebug.org/%E7%BB%BF%E7%9B%9F%E6%BC%8F%E6%B4%9E%E5%BA%93/87280.html</a> ：预防办法</p><link href="//src.wangriyu.wang/lib/Aplayer/APlayer.min.css" rel="stylesheet"><script src="//src.wangriyu.wang/lib/Aplayer/APlayer.min.js"></script><div id="aplayer"></div><script src="/js/player.js"></script></div><div class="article-info article-info-index"><div class="article-count"><div class="article-tag tagcloud"><ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/TLS/" rel="tag">TLS</a></li></ul></div><span class="post-count">总字数3.9k</span> <span class="post-count">预计阅读15分钟</span></div><div class="clearfix"></div></div></div></article><article id="post-blockcipher-padding" class="article article-type-post" itemscope itemprop="blogPost"><div class="article-meta"><a href="/2020/08/31/blockcipher-padding/" class="article-date"><time class="published" datetime="2020-08-31T08:51:03.000Z" itemprop="datePublished">2020-08-31 发布</time> <time class="updated" datetime="2020-09-03T13:12:21.311Z" itemprop="dateUpdated">2020-09-03 更新</time></a></div><div class="article-inner"><input type="hidden" class="isFancy"><header class="article-header"><h1 itemprop="name"><a class="article-title" href="/2020/08/31/blockcipher-padding/">分组密码--填充模式</a></h1></header><div class="article-entry" itemprop="articleBody"><p>转载自 <a target="_blank" rel="noopener" href="https://www.jianshu.com/p/16e1cbc0b7a9">https://www.jianshu.com/p/16e1cbc0b7a9</a></p><p>填充模式不仅仅适用于对称密码，非对称密码也会用到，比如RSA</p><p>分组密码中，需要将明文按指定大小进行分组，由于明文并非指定大小的整数倍，因此在明文的最后一个分组需要将其填充至加密算法所要求的分组大小后进行加密。</p><p>在解密时，按照同样的填充模式将填充的数据去除。</p><p>斜体表示 SunJCE 支持，非斜体为 BouncyCastle 支持</p><h3 id="NOPADDING"><a href="#NOPADDING" class="headerlink" title="NOPADDING"></a><em>NOPADDING</em></h3><p>不填充，在此填充下原始数据必须是分组大小的整数倍，非整数倍时无法使用该模式</p><h3 id="PKCS5PADDING，PKCS7PADDING"><a href="#PKCS5PADDING，PKCS7PADDING" class="headerlink" title="PKCS5PADDING，PKCS7PADDING"></a><em>PKCS5PADDING</em>，PKCS7PADDING</h3><p>填充至符合块大小的整数倍，填充值为填充数量数</p><ul><li>原始：<code>FF FF FF FF FF FF FF FF FF</code></li><li>填充：<code>FF FF FF FF FF FF FF FF FF 07 07 07 07 07 07 07</code></li></ul><p><code>PKCS5PADDING</code> 的块大小应为 8 个字节，而 <code>PKCS7PADDING</code> 的块大小可以在 1~255 的范围内。但 SunJCE 的 Provider 实现中 <code>PKCS5PADDING</code> 也按 <code>PKCS7PADDING</code> 来进行处理了。</p><h3 id="ISO10126PADDING"><a href="#ISO10126PADDING" class="headerlink" title="ISO10126PADDING"></a>ISO10126PADDING</h3><p>填充至符合块大小的整数倍，填充值最后一个字节为填充的数量数，其他字节随机处理</p><ul><li>原始：<code>FF FF FF FF FF FF FF FF FF</code></li><li>填充：<code>FF FF FF FF FF FF FF FF FF 3F 7A B4 09 14 36 07</code></li></ul><h3 id="ISO7816-4PADDING"><a href="#ISO7816-4PADDING" class="headerlink" title="ISO7816-4PADDING"></a>ISO7816-4PADDING</h3><p>填充至符合块大小的整数倍，填充值第一个字节为 0x80，其他字节填 0</p><ul><li>原始：<code>FF FF FF FF FF FF FF FF FF</code></li><li>填充：<code>FF FF FF FF FF FF FF FF FF 80 00 00 00 00 00 00</code></li></ul><h3 id="ZEROBYTEPADDING"><a href="#ZEROBYTEPADDING" class="headerlink" title="ZEROBYTEPADDING"></a>ZEROBYTEPADDING</h3><p>填充至符合块大小的整数倍，填充值为 0</p><ul><li>原始：<code>FF FF FF FF FF FF FF FF FF</code></li><li>填充：<code>FF FF FF FF FF FF FF FF FF 00 00 00 00 00 00 00</code></li></ul><h3 id="X923PADDING"><a href="#X923PADDING" class="headerlink" title="X923PADDING"></a>X923PADDING</h3><p>填充至符合块大小的整数倍，填充值最后一个字节为填充的数量数，其他字节填 0</p><ul><li>原始：<code>FF FF FF FF FF FF FF FF FF</code></li><li>填充：<code>FF FF FF FF FF FF FF FF FF 00 00 00 00 00 00 07</code></li></ul><h3 id="TBCPADDING（Trailing-Bit-Compliment）"><a href="#TBCPADDING（Trailing-Bit-Compliment）" class="headerlink" title="TBCPADDING（Trailing-Bit-Compliment）"></a>TBCPADDING（Trailing-Bit-Compliment）</h3><p>填充至符合块大小的整数倍，原文最后一位为“1”时填充 0x00，最后一位为“0”时填充“0xFF”</p><ul><li>原始：<code>FF FF FF FF FF FF FF FF FF</code></li><li>填充：<code>FF FF FF FF FF FF FF FF FF 00 00 00 00 00 00 00</code></li><li>原始：<code>FF FF FF FF FF FF FF FF F0</code></li><li>填充：<code>FF FF FF FF FF FF FF FF F0 FF FF FF FF FF FF FF</code></li></ul><h3 id="PKCS1PADDING"><a href="#PKCS1PADDING" class="headerlink" title="PKCS1PADDING"></a><em>PKCS1PADDING</em></h3><p>该填充模式是 RSA 加密中使用的，详见 <a target="_blank" rel="noopener" href="https://tools.ietf.org/html/rfc2313">RFC 2313</a>。RSA 加密时，需要将原文填充至密钥大小，填充的格式为：</p><pre><code>00 + BT + PS + 00 + D</code></pre><ul><li><code>00</code> 为固定字节</li><li><code>BT</code> 为处理模式。公钥操作时为 <code>02</code>，私钥操作为 <code>00</code> 或 <code>01</code></li><li><code>PS</code> 为填充字节，填充数量为 <code>k - 3 - D</code>，<code>k</code> 表示密钥长度，<code>D</code> 表示原文长度。<code>PS</code> 的最小长度为 8 个字节。填充的值根据 <code>BT</code> 值不同而不同：<ul><li><code>BT = 00</code> 时，填充全 <code>00</code></li><li><code>BT = 01</code> 时，填充全 <code>FF</code></li><li><code>BT = 02</code> 时，随机填充，但不能为 <code>00</code></li></ul></li></ul><link href="//src.wangriyu.wang/lib/Aplayer/APlayer.min.css" rel="stylesheet"><script src="//src.wangriyu.wang/lib/Aplayer/APlayer.min.js"></script><div id="aplayer"></div><script src="/js/player.js"></script></div><div class="article-info article-info-index"><div class="article-count"><div class="article-tag tagcloud"><ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E5%AF%86%E7%A0%81%E5%AD%A6/" rel="tag">密码学</a></li></ul></div><span class="post-count">总字数752</span> <span class="post-count">预计阅读3分钟</span></div><div class="clearfix"></div></div></div></article><nav id="page-nav"><a class="extend prev" rel="prev" href="/">&amp;laquo; Prev</a><a class="page-number" href="/">1</a><span class="page-number current">2</span><a class="page-number" href="/page/3/">3</a><a class="extend next" rel="next" href="/page/3/">Next &amp;raquo;</a></nav></div><footer id="footer"><div class="outer"><div id="footer-info"><div class="footer-left"><i class="fa fa-copyright"></i> 2017-2021 冀-18010769-1</div><div class="visit"><span id="busuanzi_container_site_pv" style="display:none"><span id="site-visit" title="本站到访人数"><i class="fa fa-user" aria-hidden="true"></i><span id="busuanzi_value_site_uv"></span> </span></span><span>| </span><span id="busuanzi_container_page_pv" style="display:none"><span id="page-visit" title="本站总访问量"><i class="fa fa-eye" aria-hidden="true"></i><span id="busuanzi_value_site_pv"></span></span></span></div><div class="footer-right"><i class="fa fa-heart"></i><a href="http://hexo.io/" target="_blank" title="快速、简洁且高效的博客框架"> Hexo</a> Theme <a href="https://github.com/MOxFIVE/hexo-theme-yelee" target="_blank" title="简而不减 Hexo 双栏博客主题  v3.5">Yelee</a></div></div></div></footer></div><script type="application/javascript">var leftWidth,hide=!1;$(".hide-left-col").click(function(){hide=hide?($(".left-col").css("width",leftWidth),$(".left-col .intrude-less").fadeIn(200),$("#tocButton").fadeIn(200),"block"===$("#switch-btn").css("display")&&"block"===$("#switch-area").css("display")||$("#toc").fadeIn(200),$(".hide-left-col").css("left",leftWidth).html('<i class="fa fa-angle-double-left"></i>'),$(".mid-col").css("left",leftWidth),$("#post-nav-button").css("left",leftWidth),$("#post-nav-button > a:nth-child(2)").css("display","block"),!1):(leftWidth=$(".left-col")[0].style.width,$(".left-col").css("width",0),$(".left-col .intrude-less").fadeOut(200),$("#toc").fadeOut(100),$("#tocButton").fadeOut(100),$(".hide-left-col").css("left",0).html('<i class="fa fa-angle-double-right"></i>'),$(".mid-col").css("left",0),$("#post-nav-button").css("left",0),$("#post-nav-button > a:nth-child(2)").css("display","none"),$(".post-list").is(":visible")&&($("#post-nav-button .fa-bars,#post-nav-button .fa-times").toggle(),$(".post-list").toggle()),!0)})</script><script data-main="/js/main.js" src="//cdn.bootcss.com/require.js/2.3.5/require.min.js"></script><script type="text/x-mathjax-config">MathJax.Hub.Config({tex2jax:{inlineMath:[["$$","$$"],["$","$"],["\\(","\\)"]],processEscapes:!0,skipTags:["script","noscript","style","textarea","pre","code"]}}),MathJax.Hub.Queue(function(){var a,e=MathJax.Hub.getAllJax();for(a=0;a<e.length;a+=1)e[a].SourceElement().parentNode.className+=" has-jax"})</script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/latest.js?config=TeX-MML-AM_CHTML" async></script><div class="scroll" id="scroll"><a href="#" title="返回顶部"><i class="fa fa-arrow-up"></i></a> <a href="#comments" title="查看评论"><i class="fa fa-comments-o"></i></a> <a href="#footer" title="转到底部"><i class="fa fa-arrow-down"></i></a></div><script>var oOpenInNew={post:".copyright a[href]",friends:"#js-friends a",socail:".social a"};for(var x in oOpenInNew)$(oOpenInNew[x]).attr("target","_blank")</script><script>var titleTime,originTitle=document.title;document.addEventListener("visibilitychange",function(){document.hidden?(document.title="(つェ⊂)"+originTitle,clearTimeout(titleTime)):(document.title="(*´∇｀*)~ "+originTitle,titleTime=setTimeout(function(){document.title=originTitle},2e3))})</script><script async src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script></div><link href="//cdn.bootcss.com/aos/2.2.0/aos.css" rel="stylesheet"><script type="text/javascript">AOS.init({easing:"ease-out-back",once:!0})</script><script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"pluginRootPath":"live2dw/","model":{"scale":1,"hHeadPos":0.5,"vHeadPos":0.618,"jsonPath":"live2d_models/live2d-widget-model-izumi"},"display":{"position":"right","width":100,"height":200,"hOffset":-50,"vOffset":-85},"mobile":{"show":false},"react":{"opacityDefault":0.9,"opacityOnHover":0.3},"log":false,"pluginJsPath":"lib/","pluginModelPath":"assets/","tagMode":false});</script></body></html>